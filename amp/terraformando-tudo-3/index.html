<!doctype html>
<html amp lang='pt-br'>
<head>
	<meta charset='utf-8'>
	<script async src='https://cdn.ampproject.org/v0.js'></script>
	<script async custom-element='amp-sidebar' src='https://cdn.ampproject.org/v0/amp-sidebar-0.1.js'></script>
	<script async custom-element='amp-image-lightbox' src='https://cdn.ampproject.org/v0/amp-image-lightbox-0.1.js'></script>
	<script async custom-element='amp-analytics' src='https://cdn.ampproject.org/v0/amp-analytics-0.1.js'></script>
	<title>Elo7 Tech - Terraformando tudo - parte 3</title>
	<meta name='description' content='Terceiro post da série &#x27;Terraformando Tudo&#x27;, que conta a nossa trajetória em busca da codificação da nossa infraestrutura. Neste post mostraremos como &quot;terraformar&quot; uma infra já existente.'>
	<link rel='canonical' href='https://engenharia.elo7.com.br/terraformando-tudo-3/' />
	<meta name='viewport' content='width=device-width,minimum-scale=1,initial-scale=1'>
	<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
	<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>
	<style amp-custom>
		body {
			background-color: white;
			font-family: 'Open Sans', sans-serif;
			color: #666;
		}

		h1 {
			color: #333;
			font-size: 1.5em;
			margin-bottom: 0;
		}

		h2, h3 {
			color: #444;
			font-size: 1.2em;
		}

		h3 {
			font-weight: 300;
		}

		a {
			text-decoration: none;
		}

		p, li {
			font-size: 0.9em;
		}

		ul {
			padding-left: 1.5em;
		}

		article {
			line-height: 1.8;
			text-align: justify;
		}

		blockquote {
			margin: 1em;
		}

		table {
			border-collapse: collapse;
			border-spacing: 0;
			font-size: 0.9em;
			width: 100%;
			text-align: left;
		}

		table thead th {
			background-color: #4a4a4a;
			color: white;
		}

		table th, table td {
			padding: 0.2em 0.5em;
		}

		tr:nth-child(even) td {
			background-color: #f3f3f3;
		}

		table th:not(:first-child), table td:not(:first-child) {
			text-align: right;
		}

		body > header {
			height: 60px;
			box-sizing: border-box;
			background-color: #FDC24F;
			text-align: center;
			padding-top: 0.8em;
			padding-bottom: 0.8em;
			position: sticky;
			top: 0;
			z-index: 10;
		}

		body > header a {
			background: url('//images.elo7.com.br/assets/v3/desktop/svg/logo-elo7.svg') no-repeat;
			background-size: 90px 35px;
			width: 90px;
			height: 35px;
			display: inline-block;
			filter: brightness(100);
		}

		.post-content, footer {
			padding-left: 5%;
			padding-right: 5%;
		}

		.post-content .content a, .post-content .content a:visited, .post-content .content a:hover {
			cursor: pointer;
			color: #000;
			font-weight: 500;
			text-decoration: underline;
			word-break: break-word;
		}

		.post-content .post-image {
			text-align: center;
			display: block;
		}

		.post-content p:last-of-type {
			margin-bottom: 0;
		}

		main {
			background-color: #ecebeb;
			padding-top: 1em;
			padding-bottom: 1em;
		}

		.post-card, .post-content, .publisher-info {
			background: white;
			margin-left: 2%;
			padding: 1em;
			margin-right: 3%;
			box-shadow: rgba(72, 72, 72, 0.23) 0 0 5px;
		}

		.publisher-info {
			margin-bottom: 1em;
		}

		.publisher-info h1 {
			margin-top: 0;
			margin-bottom: 0.5em;
		}

		.card-devops {
			border-left: 5px solid #7d7873;
		}

		.card-eventos {
			border-left: 5px solid #fdb933;
		}

		.card-front-end {
			border-left: 5px solid #c15eb4;
		}

		.card-back-end {
			border-left: 5px solid #359c9c;
		}

		.card-mobile {
			border-left: 5px solid #fa9c5e;
		}

		.card-vagas {
			border-left: 5px solid #99c799;
		}

		.card-design {
			border-left: 5px solid #7c9ec4;
		}

		.card-cultura {
			border-left: 5px solid #f44336;
		}

		.post-card:not(:last-of-type) {
			margin-bottom: 1em;
		}

		.post-card .title {
			margin-top: 0;
			margin-bottom: 0.5em;
			text-align: left;
		}

		.post-card .title a {
			color: inherit;
		}

		.author, .date {
			color: #888;
			margin-bottom: 0;
			margin-top: 0;
			font-size: 0.9em;
		}

		.author a {
			color: inherit;
			margin-bottom: 1.5em;
		}

		#sidebar {
			width: 60vw;
			background-color: #4a4a4a;
			color: #fff;
			padding-right: 1em;
			padding-left: 1em;
		}

		#sidebar li {
			margin-bottom: 0.5em;
		}

		#sidebar ul {
			margin-bottom: 1.5em;
			list-style: none;
			padding: 0;
		}

		#sidebar h2 {
			margin-bottom: 0;
		}

		#sidebar a {
			text-decoration: none;
			font-weight: 500;
		}

		#sidebar a, #sidebar h2 {
			color: inherit;
		}

		.sidebar-trigger {
			position: absolute;
			left: 5%;
			background-color: transparent;
			border: none;
			color: #fff;
			font-size: 1.8em;
			padding: 0;
		}

		.category {
			background-color: #73bebe;
			color: #ffffff;
			text-decoration: none;
			font-size: 0.8em;
			padding: .5em;
			border-radius: 3px;
			display: inline-block;
			margin-top: 2.3em;
			cursor: pointer;
			transition: background-color 0.3s;
			font-weight: 300;
		}

		.category:hover {
			background-color: #73bebe;
		}

		.post-link {
			border: 1px solid #fba702;
			border-radius: 3px;
			color: #fba702;
			display: inline-block;
			float: right;
			margin-top: 1em;
			padding: 0.8em;
			text-align: center;
			text-decoration: none;
			transition: background-color 0.3s, color 0.3s;
			font-size: 0.9em;
		}

		.post-link:hover {
			background-color: #fba702;
			color: #ffffff;
		}

		.social {
			content: '';
			width: 25px;
			height: 25px;
			display: inline-block;
			background-position: center;
			text-indent: -9999px;
			margin-right: 0.5em;
			background-size: contain;
			vertical-align: top;
		}

		.social.twitter {
			background-image: url('/images/ico/ic-twitter.svg');
		}

		.social.linkedin {
			background-image: url('/images/ico/ic-linkedin.svg');
		}

		.social.github {
			background-image: url('/images/ico/ic-github.svg');
		}

		footer {
			background-color: #4a4a4a;
			padding-top: 0.5em;
			padding-bottom: 0.5em;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		footer a {
			color: #fff;
			text-decoration: none;
			font-size: 0.8em;
		}

		.footer-social {
			line-height: 0;
		}

		.footer-social a {
			background-size: 2em 2em;
			background-repeat: no-repeat;
			display: inline-block;
			height: 2em;
			width: 2em;
			overflow: hidden;
			text-indent: -9999px;
		}

		.footer-social a + a {
			margin-left: 0.5em;
		}

		.footer-social .github {
			background-image: url('/images/github_icon.svg');
		}
		.footer-social .email {
			background-image: url('/images/email_icon.png');
		}

		.footer-social .rss {
			background-image: url('/images/ico/feed.svg');
		}

		.footer-social .twitter {
            background-image: url('/images/ico/ic-negative-twitter.svg');
        }

		.share {
			position: relative;
			text-align: right;
			margin-top: 1em;
		}

		.share .link-share {
				display: inline-block;
				width: 30px;
				height: 30px;
				text-indent: -9999px;
				margin-left: 0.5em;
				text-align: left;
		}

		.share .link-share.facebook {
			background-image: url('/images/ico/ic-facebook.svg');
		}

		.share .link-share.twitter {
			background-image: url('/images/ico/ic-twitter.svg');
		}

		.link-input {
			opacity: 0;
			position: absolute;
			left: -9999px;
		}

		.copy-success {
			font-size: 0.75em;
			opacity: 0;
			position: absolute;
			right: 0;
			top: 125%;
			transition: opacity ease-in-out 250ms;
			text-align: center;
		}

		.copy-success.active {
			opacity: 1;
		}

		code {
			background-color: #ececec;
			padding: 0.1em 0.2em;
		}

		.hide {
			display: none;
		}

		.highlight code {
			overflow: auto;
		}

		.hljs {
			display: block;
			padding: 0.5em 1em;
			background: #23241f;
		}

		.hljs,
		.hljs-tag,
		.css .hljs-rules,
		.css .hljs-value,
		.css .hljs-function
		.hljs-preprocessor,
		.hljs-pragma {
			color: #f8f8f2;
		}

		.hljs-strongemphasis,
		.hljs-strong,
		.hljs-emphasis {
			color: #a8a8a2;
		}

		.hljs-bullet,
		.hljs-blockquote,
		.hljs-horizontal_rule,
		.hljs-number,
		.hljs-regexp,
		.alias .hljs-keyword,
		.hljs-literal,
		.hljs-hexcolor {
			color: #ae81ff;
		}

		.hljs-tag .hljs-value,
		.hljs-code,
		.hljs-title,
		.css .hljs-class,
		.hljs-class .hljs-title:last-child {
			color: #a6e22e;
		}

		.hljs-link_url {
			font-size: 80%;
		}

		.hljs-strong,
		.hljs-strongemphasis {
			font-weight: bold;
		}

		.hljs-emphasis,
		.hljs-strongemphasis,
		.hljs-class .hljs-title:last-child {
			font-style: italic;
		}

		.hljs-keyword,
		.hljs-function,
		.hljs-change,
		.hljs-winutils,
		.hljs-flow,
		.lisp .hljs-title,
		.clojure .hljs-built_in,
		.nginx .hljs-title,
		.tex .hljs-special,
		.hljs-header,
		.hljs-attribute,
		.hljs-symbol,
		.hljs-symbol .hljs-string,
		.hljs-tag .hljs-title,
		.hljs-value,
		.alias .hljs-keyword:first-child,
		.css .hljs-tag,
		.css .unit,
		.css .hljs-important {
			color: #F92672;
		}

		.hljs-function .hljs-keyword,
		.hljs-class .hljs-keyword:first-child,
		.hljs-constant,
		.css .hljs-attribute {
			color: #66d9ef;
		}

		.hljs-variable,
		.hljs-params,
		.hljs-class .hljs-title {
			color: #f8f8f2;
		}

		.hljs-string,
		.css .hljs-id,
		.hljs-subst,
		.haskell .hljs-type,
		.ruby .hljs-class .hljs-parent,
		.hljs-built_in,
		.sql .hljs-aggregate,
		.django .hljs-template_tag,
		.django .hljs-variable,
		.smalltalk .hljs-class,
		.django .hljs-filter .hljs-argument,
		.smalltalk .hljs-localvars,
		.smalltalk .hljs-array,
		.hljs-attr_selector,
		.hljs-pseudo,
		.hljs-addition,
		.hljs-stream,
		.hljs-envvar,
		.apache .hljs-tag,
		.apache .hljs-cbracket,
		.tex .hljs-command,
		.hljs-prompt,
		.hljs-link_label,
		.hljs-link_url {
			color: #e6db74;
		}

		.hljs-comment,
		.hljs-javadoc,
		.java .hljs-annotation,
		.python .hljs-decorator,
		.hljs-template_comment,
		.hljs-pi,
		.hljs-doctype,
		.hljs-deletion,
		.hljs-shebang,
		.apache .hljs-sqbracket,
		.tex .hljs-formula {
			color: #75715e;
		}

		.coffeescript .javascript,
		.javascript .xml,
		.tex .hljs-formula,
		.xml .javascript,
		.xml .vbscript,
		.xml .css,
		.xml .hljs-cdata,
		.xml .php,
		.php .xml {
			opacity: 0.5;
		}
	</style>
</head>
<body itemscope itemtype='http://schema.org/WebPage'>
	<amp-sidebar id='sidebar' layout='nodisplay'>
		<h2>Categorias</h2>
		<ul>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/back-end/'>
						<span itemprop='name'>back-end</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/cultura/'>
						<span itemprop='name'>cultura</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/data-science/'>
						<span itemprop='name'>data-science</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/design/'>
						<span itemprop='name'>design</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/devops/'>
						<span itemprop='name'>devops</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/eventos/'>
						<span itemprop='name'>eventos</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/front-end/'>
						<span itemprop='name'>front-end</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/mobile/'>
						<span itemprop='name'>mobile</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/vagas/'>
						<span itemprop='name'>vagas</span>
					</a>
				</li>
			
		</ul>
		<h2>Veja também</h2>
		<ul>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a itemprop='url' href='http://carreira.elo7.com.br/engenharia/' target='_blank'>
					<span itemprop='name'>A engenharia</span>
				</a>
			</li>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a itemprop='url' href='http://carreira.elo7.com.br/' target='_blank'>
					<span itemprop='name'>Carreiras</span>
				</a>
			</li>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a itemprop='url' href='http://eventos.elo7.com.br/' target='_blank'>
					<span itemprop='name'>Nossos eventos</span>
				</a>
			</li>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a itemprop='url' href='https://www.elo7.com.br/' target='_blank'>
					<span itemprop='name'>Elo7</span>
				</a>
			</li>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a rel='external' itemprop='url' href='https://github.com/elo7/tech-blog'>Github</a>
			</li>
		</ul>
		</ul>
	</amp-sidebar>
	<header>
		<button class='sidebar-trigger' on='tap:sidebar'>☰</button>
		<a rel='home' itemprop='url' href='/amp/home/' class='logo'></a></header>

	<main itemscope itemtype='http://schema.org/Blog'>
		<article itemprop='blogPost' itemscope itemtype='http://schema.org/BlogPosting' class='post-card post-content'>
	<h1 itemprop='name' class='title'>Terraformando tudo - parte 3</h1>
	<div class='post-meta'>
		<p class='date'>
			Publicado em: <time datetime='18/09/2017' itemprop='datePublished'>18/09/2017</time>
			<meta itemprop='dateModified' content='18/09/2017'>
		</p>

		<article>
			
				<a data-author='lucasvasconcelos' itemprop='author' itemscope itemtype='http://schema.org/Person' rel='author' href='/amp/lucasvasconcelos/' class='author'>
					<meta itemprop='url' content='/amp/lucasvasconcelos'>
					<span itemprop='name' class='publisher' data-author='lucasvasconcelos'>@lucasvasconcelos</span>
					<meta itemprop='worksFor' content='Elo7 Serviços de Informática SA'>
				</a>
			
		</article>
	</div>
	<div class='content' itemprop='articleBody'>
		<p>Veja os outros <em>posts</em> da série:</p>
<ul>
<li><a href="/terraformando-tudo-1/">Terraformando tudo - parte 1</a></li>
<li><a href="/terraformando-tudo-2/">Terraformando tudo - parte 2</a></li>
</ul>
<p>Olár!</p>
<p>Como foi prometido no <a href="/terraformando-tudo-2/">segundo post</a>, estamos aqui novamente. Agora, para responder uma das perguntas que sempre são feitas na hora de adotar uma nova ferramenta: &quot;E o legado?&quot;</p>
<p>No contexto de Infraestrutura como Código, o legado é a infra já existente. No caso do Elo7, são todos os recursos criados &quot;na base do mouse&quot; pelo console da AWS.</p>
<p>Também é válido lembrar que esse cenário não ocorre apenas com ambientes legados. Ele pode ocorrer em uma situação de emergência, onde o plantonista ou time responsável é obrigado a fazer alguma alteração na infra via console/interface web para corrigir algum problema. Nesse caso também teremos inconsistências entre o estado encontrado no código e no <em>provider</em>.</p>
<h2>O caminho inverso</h2>
<p>Se até agora o Terraform gerou estados baseados no código, agora vamos fazer o caminho inverso: vamos gerar estados de uma infra já existente no <em>provider</em> e escrever código que se encaixa nesse estado.</p>
<p>O Terraform vai nos ajudar na primeira parte do caminho, gerando os estados da infra existente através do <a href="https://www.terraform.io/docs/import/index.html">comando <code>import</code></a>.</p>
<p>Antes das demonstrações, devemos nos atentar às limitações dessa funcionalidade:</p>
<ul>
<li>Os <code>resources</code> suportados pelo <code>import</code> do Terraform não são os mesmos que temos à disposição para criar do zero no Terraform. Ou seja, nem todos recursos que podem ser criados através do código podem ser importados. A boa notícia é que a cada nova <em>release</em> do Terraform (que possui ciclo de vida de aproximadamente 20 dias) novos recursos para importação são adicionados. Em um caso onde o recurso (Redshift, Lambda, etc) não for suportado pelo <code>import</code>, pode-se criar um estado manualmente ou utilizar ferramentas de terceiros. <a href="https://www.terraform.io/docs/import/importability.html">Uma lista dos <code>resources</code> suportados atualmente pode ser vista aqui</a>. E, caso quiser, é relativamente fácil fazer com que um <code>resource</code> seja &quot;importável&quot;, como pode ser visto nesse <a href="https://github.com/hashicorp/terraform/pull/15237/files">PR</a>;</li>
<li>O <code>import</code> não gera código! Ele gera o estado daquele recurso apenas, cabendo a nós a escrita do código referente ao estado gerado.</li>
</ul>
<p>Com esses pontos em mente, vamos ver como podemos utilizar o <code>import</code>.</p>
<h2>Usando o <code>import</code></h2>
<p>Para o <code>import</code>, devemos ter em mãos três informações (mais informações sobre o <em>pattern</em> do Terraform <a href="/terraformando-tudo-2/">no segundo post</a>):</p>
<ul>
<li>Tipo do recurso</li>
<li>Nome do recurso</li>
<li>ID do recurso na AWS</li>
</ul>
<p>Vamos ver como funciona o <code>import</code> de uma instância EC2?</p>
<h3>Importando um <code>resource</code></h3>
<p>O exemplo a seguir mostra o <code>import</code> de uma instância existente na AWS. Primeiro, vamos nomear nossas variáveis:</p>
<ul>
<li><strong>Tipo do recurso:</strong> <code>aws_instance</code></li>
<li><strong>Nome do recurso:</strong> <code>elo7-ec2-example</code></li>
<li><strong>ID do recurso na AWS:</strong> <code>i-a1b2c3</code> (Como a instância já existe na AWS, temos o ID dela)</li>
</ul>
<p>Agora, vamos rodar o <code>import</code> (sim! É apenas um comando!):</p>
<pre class="highlight"><code class="hljs python">$ terraform <span class="hljs-keyword">import</span> aws_instance.elo7-ec2-example i-a1b2c3
</code></pre>
<p>Onde</p>
<pre class="highlight"><code class="hljs python">$ terraform  <span class="hljs-keyword">import</span>  aws_instance.elo7-ec2-example  i-a1b2c3
|__________| |_____| |___________| |______________| |______|
      |       |           |           |                |
Comando do    |        Tipo de        |         ID do resource
 Terraform    |        Resource       |            na AWS
              |                       |
          Funcionalidade         Nome do resource
            de <span class="hljs-keyword">import</span>             no Terraform
</code></pre>
<p>Ao executar o comando, temos uma saída dizendo que tudo correu bem:</p>
<pre class="highlight"><code class="hljs pf">$ terraform import aws_instance.elo7-ec2-example i-a1b2c3
aws_instance.elo7-ec2-example: Importing <span class="hljs-keyword">from</span> ID <span class="hljs-string">"i-a1b2c3"</span>...
aws_instance.elo7-ec2-example: Import complete!
  Imported aws_instance (ID: i-a1b2c3)
aws_instance.elo7-ec2-example: Refreshing <span class="hljs-keyword">state</span>... (ID: i-a1b2c3)

Import success! The resources imported are shown above. These are
now <span class="hljs-keyword">in</span> your Terraform <span class="hljs-keyword">state</span>. Import does not currently generate
configuration, so you must do this next. If you do not create configuration
<span class="hljs-keyword">for</span> the above resources, then the next `terraform plan` will mark
them <span class="hljs-keyword">for</span> destruction
</code></pre>
<p>E por último, mas não menos importante, o estado que o Terraform gera:</p>
<pre class="highlight"><code class="hljs python"><span class="hljs-string">"aws_instance.elo7-ec2-example"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"aws_instance"</span>,
    <span class="hljs-string">"depends_on"</span>: [],
    <span class="hljs-string">"primary"</span>: {
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"i-a1b2c3"</span>,
        <span class="hljs-string">"attributes"</span>: {
            <span class="hljs-string">"ami"</span>: <span class="hljs-string">"ami-z9e334"</span>,
            <span class="hljs-string">"availability_zone"</span>: <span class="hljs-string">"us-west-1a"</span>,
            <span class="hljs-string">"disable_api_termination"</span>: <span class="hljs-string">"false"</span>,
            <span class="hljs-string">"ebs_block_device.#"</span>: <span class="hljs-string">"0"</span>,
            <span class="hljs-string">"ebs_optimized"</span>: <span class="hljs-string">"false"</span>,
            <span class="hljs-string">"ephemeral_block_device.#"</span>: <span class="hljs-string">"0"</span>,
            <span class="hljs-string">"iam_instance_profile"</span>: <span class="hljs-string">"example-web-app"</span>,
            <span class="hljs-string">"id"</span>: <span class="hljs-string">"i-a1b2c3"</span>,
            <span class="hljs-string">"instance_state"</span>: <span class="hljs-string">"running"</span>,
            <span class="hljs-string">"instance_type"</span>: <span class="hljs-string">"t2.large"</span>,
            <span class="hljs-string">"key_name"</span>: <span class="hljs-string">"key-web-app"</span>,
            <span class="hljs-string">"monitoring"</span>: <span class="hljs-string">"false"</span>,
            <span class="hljs-string">"network_interface_id"</span>: <span class="hljs-string">"eni-5643f442"</span>,
            <span class="hljs-string">"private_dns"</span>: <span class="hljs-string">"ip-10-0-3-54.us-west-1.compute.internal"</span>,
            <span class="hljs-string">"private_ip"</span>: <span class="hljs-string">"10.0.3.54"</span>,
            <span class="hljs-string">"public_dns"</span>: <span class="hljs-string">""</span>,
            <span class="hljs-string">"public_ip"</span>: <span class="hljs-string">""</span>,
            <span class="hljs-string">"root_block_device.#"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"root_block_device.0.delete_on_termination"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"root_block_device.0.iops"</span>: <span class="hljs-string">"100"</span>,
            <span class="hljs-string">"root_block_device.0.volume_size"</span>: <span class="hljs-string">"8"</span>,
            <span class="hljs-string">"root_block_device.0.volume_type"</span>: <span class="hljs-string">"gp2"</span>,
            <span class="hljs-string">"security_groups.#"</span>: <span class="hljs-string">"0"</span>,
            <span class="hljs-string">"source_dest_check"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"subnet_id"</span>: <span class="hljs-string">"subnet-674f3556"</span>,
            <span class="hljs-string">"tags.%"</span>: <span class="hljs-string">"3"</span>,
            <span class="hljs-string">"tags.Name"</span>: <span class="hljs-string">"web-app"</span>,
            <span class="hljs-string">"tags.env"</span>: <span class="hljs-string">"dev"</span>,
            <span class="hljs-string">"tenancy"</span>: <span class="hljs-string">"default"</span>,
            <span class="hljs-string">"user_data"</span>: <span class="hljs-string">"d2a580ddfbcb7e5ba2e00833805981ac61d500df"</span>,
            <span class="hljs-string">"vpc_security_group_ids.#"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"vpc_security_group_ids.4021914259"</span>: <span class="hljs-string">"sg-8f38de4"</span>
        },
        <span class="hljs-string">"meta"</span>: {
            <span class="hljs-string">"schema_version"</span>: <span class="hljs-string">"1"</span>
        },
        <span class="hljs-string">"tainted"</span>: false
    },
    <span class="hljs-string">"deposed"</span>: [],
    <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws"</span>
}
</code></pre>
<p>Pronto! Já rodamos o <code>import</code> e possuímos nossa infra criada manualmente no idioma do Terraform! :)</p>
<p>Mas lembram que isso é só a primeira parte do caminho? Esse comando não gera o código, e isso pode trazer consequências gravíssimas, pois <strong>podemos destruir a infra que acabamos de importar</strong>.</p>
<p>Sim, isso é possível. Porque, no momento em que um <code>apply</code> for executado, o Terraform irá tentar destruir a infra que não existe em seu código e existe em seu estado que, <a href="/terraformando-tudo-1/">como já vimos</a>, é o comportamento esperado. Para provar esse ponto, vejamos a saída de um <code>terraform plan</code>:</p>
<pre class="highlight"><code class="hljs undefined">$ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but
will not be persisted to local or remote state storage.

aws_instance.elo7-ec2-example: Refreshing state... (ID: i-a1b2c3)

The Terraform execution plan has been generated and is shown below.
Resources are shown in alphabetical order for quick scanning. Green resources
will be created (or destroyed and then created if an existing resource
exists), yellow resources are being changed in-place, and red resources
will be destroyed. Cyan entries are data sources to be read.

Note: You didn't specify an "-out" parameter to save this plan, so when
"apply" is called, Terraform can't guarantee this is what will execute.

- aws_instance.elo7-ec2-example


Plan: 0 to add, 0 to change, 1 to destroy.
</code></pre>
<p><strong>NUNCA execute o <code>apply</code> nesse momento :|</strong></p>
<h2>Segunda parte do caminho: escrevendo o código</h2>
<p>Temos duas opções:</p>
<ul>
<li>Escrever o código manualmente;</li>
<li>Gerar o código utilizando a ferramenta <a href="https://github.com/dtan4/terraforming">terraforming</a> (essa ferramenta é específica para recursos na AWS).</li>
</ul>
<p>A escolha mais correta é utilizar uma ferramenta que vai fazer o trabalho para nós mas, por questões didáticas, vamos mostrar o processo de escrita manual do código.</p>
<p>Para fazer isso, devemos pegar as informações relevantes do estado e gerar um <em>configuration</em>. Nesse caso, estamos importando uma instância EC2 e vamos precisar retirar do estado as seguintes informações:</p>
<ul>
<li><strong>Nome do resource:</strong> <code>elo7-ec2-example</code></li>
<li><strong>ID da AMI:</strong> <code>ami-z9e334</code></li>
<li><strong>Tipo da instância:</strong> <code>t2.large</code></li>
<li><strong>Nome da chave:</strong> <code>key-web-app</code></li>
<li><strong>ID da subnet:</strong> <code>subnet-674f3556</code></li>
<li><strong>Security groups:</strong> <code>sg-8f38de4</code></li>
<li><strong>IAM Instance Profile:</strong> <code>example-web-app</code></li>
<li><strong>EC2 Tags:</strong> <code>Name: web-app, env: test</code></li>
</ul>
<p>Cada <code>resource</code> depende de um conjunto mínimo de informações para que possa ser definido. Mais informações podem ser vistas na <a href="https://www.terraform.io/docs/">documentação oficial</a>.</p>
<p>Com os dados obtidos, podemos gerar o código:</p>
<pre class="highlight"><code class="hljs python">resource aws_instance <span class="hljs-string">"elo7-ec2-example"</span> {
    ami = <span class="hljs-string">"ami-z9e334"</span>
    instance_type = <span class="hljs-string">"t2.large"</span>
    key_name = <span class="hljs-string">"key-web-app"</span>
    subnet_id = <span class="hljs-string">"subnet-674f3556"</span>
    vpc_security_group_ids = [ <span class="hljs-string">"sg-8f38de4"</span> ]
    iam_instance_profile = <span class="hljs-string">"example-web-app"</span>

    tags {
        Name = <span class="hljs-string">"web-app"</span>
        env = <span class="hljs-string">"test"</span>
    }
}
</code></pre>
<p>Podemos testar nosso código executando o comando <code>plan</code>. O sucesso da importação se dá quando esse comando indica que nenhuma mudança será feita, nos dizendo que não há inconsistências entre código e estado:</p>
<pre class="highlight"><code class="hljs undefined">$ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but
will not be persisted to local or remote state storage.

aws_instance.elo7-ec2-example: Refreshing state... (ID: i-a1b2c3)

No changes. Infrastructure is up-to-date. This means that Terraform
could not detect any differences between your configuration and
the real physical resources that exist. As a result, Terraform
doesn't need to do anything.
</code></pre>
<p>No dia-a-dia, com certeza iremos preferir utilizar a ferramenta <code>terraforming</code> citada acima. Nós já usamos ela bastante por aqui e não tivemos problemas. Mais informações sobre como utilizá-la podem ser vistas <a href="https://github.com/dtan4/terraforming">na página da ferramenta</a>.</p>
<h2>Conclusões</h2>
<p>Esperamos ter respondido com clareza a resposta da pergunta &quot;E o legado?&quot; quando se trata de Infraestrutura como Código e Terraform.</p>
<p>É recomendado que, ao utilizar o comando <code>import</code>, o usuário já possua alguma vivência com o Terraform e conheça bem os conceitos dos <code>resources</code> que serão importados, pois existem pontos do procedimento nos quais os estados são inconsistentes e um comando errado pode causar catástrofes. Cuidado com <code>resources</code> como registros de DNS e <em>load balancers</em>.</p>
<p>Um outro detalhe foi que, aqui no Elo7, não saímos importando tudo que já existia de uma vez, decidimos fazer por demanda. Assim, quando uma mudança na infra de uma aplicação era necessária, aproveitávamos e fazíamos o <code>import</code>.</p>
<p>Logo voltamos com mais posts sobre Terraform! Obrigado! :D</p>

		<section class='share'>
			<a href='https://www.facebook.com/dialog/share?app_id=644444999041914&href=https://engenharia.elo7.com.br/amp/terraformando-tudo-3/&display=popup' rel='noopener' target='_blank' class='link-share facebook' title='Clique para compartilhar no Facebook'>
				Compartilhar no facebook
			</a>
			<a href='https://twitter.com/intent/tweet?text=Terraformando tudo - parte 3&url=https://engenharia.elo7.com.br/amp/terraformando-tudo-3/&hashtags=elo7tech' rel='noopener' target='_blank' class='link-share twitter' title='Clique para compartilhar no Twitter'>
				Compartilhar no twitter
			</a>
		</section>
	</div>
	<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"> <!--Change for a post image-->
		<link href="/images/ico/elo7.png" itemprop="url"/>
		<meta itemprop='width' content='100px'/>
		<meta itemprop='height' content='100px'/>
	</span>

	<meta itemprop='headline' content='Terceiro post da série &#x27;Terraformando Tudo&#x27;, que conta a nossa trajetória em busca da codificação da nossa infraestrutura. Neste post mostraremos como &quot;terraformar&quot; uma infra já existente.'/>
	<span itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
		<meta itemprop='name' content='Elo7 Tech'/>
		<meta itemprop="url" content='https://engenharia.elo7.com.br'/>
		<span itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
			<link href="https://images.elo7.com.br/assets/v3/desktop/png/logo-elo7.png" itemprop="url"/>
			<meta itemprop='width' content='100px'/>
			<meta itemprop='height' content='100px'/>
		</span>
	</span>
	<meta itemprop='mainEntityOfPage' content='Elo7 Serviços de Informática SA'/>
</article>
	</main>
	<footer itemscope itemtype='http://schema.org/Organization'>
		<a rel='home' itemprop='url' href='/amp/home/'>engenharia.elo7.com.br © 2017</a>
		<meta itemprop='name' content='Elo7 Serviços de Informática SA'/>
		<section class='footer-social'>
			<a title='Github do Elo7' rel='external' itemprop='url' href='https://github.com/elo7' target='_blank' class='github'>Github do Elo7</a>
			<a title='Twitter do Elo7' rel='external' itemprop='url' href='https://twitter.com/elo7tech' target='_blank' class='twitter'>Twitter do Elo7</a>
			<a title='RSS do Elo7' rel='external' itemprop='url' href='https://engenharia.elo7.com.br/rss.xml' target='_blank' class='rss'>RSS do Elo7</a>
			<a title='Newsletter do Elo7' rel='external' itemprop='url' href='http://eepurl.com/cVUwvH' target='_blank' class='email'>Newsletter do Elo7</a>
		</section>
	</footer>
	<amp-analytics type='googleanalytics'>
		<script type='application/json'>
			{
				"vars": {
					"account": "UA-3692628-29"
				},
				"triggers": {
					"trackPageview": {
						"on": "visible",
						"request": "pageview"
					}
				}
			}
		</script>
	</amp-analytics>
</body>
</html>
