<!doctype html>
<html amp lang='pt-br'>
<head>
	<meta charset='utf-8'>
	<script async src='https://cdn.ampproject.org/v0.js'></script>
	<script async custom-element='amp-sidebar' src='https://cdn.ampproject.org/v0/amp-sidebar-0.1.js'></script>
	<script async custom-element='amp-image-lightbox' src='https://cdn.ampproject.org/v0/amp-image-lightbox-0.1.js'></script>
	<script async custom-element='amp-analytics' src='https://cdn.ampproject.org/v0/amp-analytics-0.1.js'></script>
	<title>Elo7 Tech - Testes de código com Mockito (2) - Novidades da nova versão</title>
	<meta name='description' content='Há algum tempo, escrevi sobre o funcionamento e os principais recursos do Mockito. Neste post, vamos conhecer as novidades da nova versão do framework.'>
	<link rel='canonical' href='https://engenharia.elo7.com.br/testes-codigo-mockito-2/' />
	<meta name='viewport' content='width=device-width,minimum-scale=1,initial-scale=1'>
	<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
	<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>
	<style amp-custom>
		body {
			background-color: white;
			font-family: 'Open Sans', sans-serif;
			color: #666;
		}

		h1 {
			color: #333;
			font-size: 1.5em;
			margin-bottom: 0;
		}

		h2, h3 {
			color: #444;
			font-size: 1.2em;
		}

		h3 {
			font-weight: 300;
		}

		a {
			text-decoration: none;
		}

		p, li {
			font-size: 0.9em;
		}

		ul {
			padding-left: 1.5em;
		}

		article {
			line-height: 1.8;
			text-align: justify;
		}

		blockquote {
			margin: 1em;
		}

		table {
			border-collapse: collapse;
			border-spacing: 0;
			font-size: 0.9em;
			width: 100%;
			text-align: left;
		}

		table thead th {
			background-color: #4a4a4a;
			color: white;
		}

		table th, table td {
			padding: 0.2em 0.5em;
		}

		tr:nth-child(even) td {
			background-color: #f3f3f3;
		}

		table th:not(:first-child), table td:not(:first-child) {
			text-align: right;
		}

		body > header {
			height: 60px;
			box-sizing: border-box;
			background-color: #FDC24F;
			text-align: center;
			padding-top: 0.8em;
			padding-bottom: 0.8em;
			position: sticky;
			top: 0;
			z-index: 10;
		}

		body > header a {
			background: url('//images.elo7.com.br/assets/v3/desktop/svg/logo-elo7.svg') no-repeat;
			background-size: 90px 35px;
			width: 90px;
			height: 35px;
			display: inline-block;
			filter: brightness(100);
		}

		.post-content, footer {
			padding-left: 5%;
			padding-right: 5%;
		}

		.post-content .content a, .post-content .content a:visited, .post-content .content a:hover {
			cursor: pointer;
			color: #000;
			font-weight: 500;
			text-decoration: underline;
			word-break: break-word;
		}

		.post-content .post-image {
			text-align: center;
			display: block;
		}

		.post-content p:last-of-type {
			margin-bottom: 0;
		}

		main {
			background-color: #ecebeb;
			padding-top: 1em;
			padding-bottom: 1em;
		}

		.post-card, .post-content, .publisher-info {
			background: white;
			margin-left: 2%;
			padding: 1em;
			margin-right: 3%;
			box-shadow: rgba(72, 72, 72, 0.23) 0 0 5px;
		}

		.publisher-info {
			margin-bottom: 1em;
		}

		.publisher-info h1 {
			margin-top: 0;
			margin-bottom: 0.5em;
		}

		.card-devops {
			border-left: 5px solid #7d7873;
		}

		.card-eventos {
			border-left: 5px solid #fdb933;
		}

		.card-front-end {
			border-left: 5px solid #c15eb4;
		}

		.card-back-end {
			border-left: 5px solid #359c9c;
		}

		.card-mobile {
			border-left: 5px solid #fa9c5e;
		}

		.card-vagas {
			border-left: 5px solid #99c799;
		}

		.card-design {
			border-left: 5px solid #7c9ec4;
		}

		.card-cultura {
			border-left: 5px solid #f44336;
		}

		.post-card:not(:last-of-type) {
			margin-bottom: 1em;
		}

		.post-card .title {
			margin-top: 0;
			margin-bottom: 0.5em;
			text-align: left;
		}

		.post-card .title a {
			color: inherit;
		}

		.author, .date {
			color: #888;
			margin-bottom: 0;
			margin-top: 0;
			font-size: 0.9em;
		}

		.author a {
			color: inherit;
			margin-bottom: 1.5em;
		}

		#sidebar {
			width: 60vw;
			background-color: #4a4a4a;
			color: #fff;
			padding-right: 1em;
			padding-left: 1em;
		}

		#sidebar li {
			margin-bottom: 0.5em;
		}

		#sidebar ul {
			margin-bottom: 1.5em;
			list-style: none;
			padding: 0;
		}

		#sidebar h2 {
			margin-bottom: 0;
		}

		#sidebar a {
			text-decoration: none;
			font-weight: 500;
		}

		#sidebar a, #sidebar h2 {
			color: inherit;
		}

		.sidebar-trigger {
			position: absolute;
			left: 5%;
			background-color: transparent;
			border: none;
			color: #fff;
			font-size: 1.8em;
			padding: 0;
		}

		.category {
			background-color: #73bebe;
			color: #ffffff;
			text-decoration: none;
			font-size: 0.8em;
			padding: .5em;
			border-radius: 3px;
			display: inline-block;
			margin-top: 2.3em;
			cursor: pointer;
			transition: background-color 0.3s;
			font-weight: 300;
		}

		.category:hover {
			background-color: #73bebe;
		}

		.post-link {
			border: 1px solid #fba702;
			border-radius: 3px;
			color: #fba702;
			display: inline-block;
			float: right;
			margin-top: 1em;
			padding: 0.8em;
			text-align: center;
			text-decoration: none;
			transition: background-color 0.3s, color 0.3s;
			font-size: 0.9em;
		}

		.post-link:hover {
			background-color: #fba702;
			color: #ffffff;
		}

		.social {
			content: '';
			width: 25px;
			height: 25px;
			display: inline-block;
			background-position: center;
			text-indent: -9999px;
			margin-right: 0.5em;
			background-size: contain;
			vertical-align: top;
		}

		.social.twitter {
			background-image: url('/images/ico/ic-twitter.svg');
		}

		.social.linkedin {
			background-image: url('/images/ico/ic-linkedin.svg');
		}

		.social.github {
			background-image: url('/images/ico/ic-github.svg');
		}

		footer {
			background-color: #4a4a4a;
			padding-top: 0.5em;
			padding-bottom: 0.5em;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		footer a {
			color: #fff;
			text-decoration: none;
			font-size: 0.8em;
		}

		.footer-social {
			line-height: 0;
		}

		.footer-social a {
			background-size: 2em 2em;
			background-repeat: no-repeat;
			display: inline-block;
			height: 2em;
			width: 2em;
			overflow: hidden;
			text-indent: -9999px;
		}

		.footer-social a + a {
			margin-left: 0.5em;
		}

		.footer-social .github {
			background-image: url('/images/github_icon.svg');
		}
		.footer-social .email {
			background-image: url('/images/email_icon.png');
		}

		.footer-social .rss {
			background-image: url('/images/ico/feed.svg');
		}

		.footer-social .twitter {
            background-image: url('/images/ico/ic-negative-twitter.svg');
        }

		.share {
			position: relative;
			text-align: right;
			margin-top: 1em;
		}

		.share .link-share {
				display: inline-block;
				width: 30px;
				height: 30px;
				text-indent: -9999px;
				margin-left: 0.5em;
				text-align: left;
		}

		.share .link-share.facebook {
			background-image: url('/images/ico/ic-facebook.svg');
		}

		.share .link-share.twitter {
			background-image: url('/images/ico/ic-twitter.svg');
		}

		.link-input {
			opacity: 0;
			position: absolute;
			left: -9999px;
		}

		.copy-success {
			font-size: 0.75em;
			opacity: 0;
			position: absolute;
			right: 0;
			top: 125%;
			transition: opacity ease-in-out 250ms;
			text-align: center;
		}

		.copy-success.active {
			opacity: 1;
		}

		code {
			background-color: #ececec;
			padding: 0.1em 0.2em;
		}

		.hide {
			display: none;
		}

		.highlight code {
			overflow: auto;
		}

		.hljs {
			display: block;
			padding: 0.5em 1em;
			background: #23241f;
		}

		.hljs,
		.hljs-tag,
		.css .hljs-rules,
		.css .hljs-value,
		.css .hljs-function
		.hljs-preprocessor,
		.hljs-pragma {
			color: #f8f8f2;
		}

		.hljs-strongemphasis,
		.hljs-strong,
		.hljs-emphasis {
			color: #a8a8a2;
		}

		.hljs-bullet,
		.hljs-blockquote,
		.hljs-horizontal_rule,
		.hljs-number,
		.hljs-regexp,
		.alias .hljs-keyword,
		.hljs-literal,
		.hljs-hexcolor {
			color: #ae81ff;
		}

		.hljs-tag .hljs-value,
		.hljs-code,
		.hljs-title,
		.css .hljs-class,
		.hljs-class .hljs-title:last-child {
			color: #a6e22e;
		}

		.hljs-link_url {
			font-size: 80%;
		}

		.hljs-strong,
		.hljs-strongemphasis {
			font-weight: bold;
		}

		.hljs-emphasis,
		.hljs-strongemphasis,
		.hljs-class .hljs-title:last-child {
			font-style: italic;
		}

		.hljs-keyword,
		.hljs-function,
		.hljs-change,
		.hljs-winutils,
		.hljs-flow,
		.lisp .hljs-title,
		.clojure .hljs-built_in,
		.nginx .hljs-title,
		.tex .hljs-special,
		.hljs-header,
		.hljs-attribute,
		.hljs-symbol,
		.hljs-symbol .hljs-string,
		.hljs-tag .hljs-title,
		.hljs-value,
		.alias .hljs-keyword:first-child,
		.css .hljs-tag,
		.css .unit,
		.css .hljs-important {
			color: #F92672;
		}

		.hljs-function .hljs-keyword,
		.hljs-class .hljs-keyword:first-child,
		.hljs-constant,
		.css .hljs-attribute {
			color: #66d9ef;
		}

		.hljs-variable,
		.hljs-params,
		.hljs-class .hljs-title {
			color: #f8f8f2;
		}

		.hljs-string,
		.css .hljs-id,
		.hljs-subst,
		.haskell .hljs-type,
		.ruby .hljs-class .hljs-parent,
		.hljs-built_in,
		.sql .hljs-aggregate,
		.django .hljs-template_tag,
		.django .hljs-variable,
		.smalltalk .hljs-class,
		.django .hljs-filter .hljs-argument,
		.smalltalk .hljs-localvars,
		.smalltalk .hljs-array,
		.hljs-attr_selector,
		.hljs-pseudo,
		.hljs-addition,
		.hljs-stream,
		.hljs-envvar,
		.apache .hljs-tag,
		.apache .hljs-cbracket,
		.tex .hljs-command,
		.hljs-prompt,
		.hljs-link_label,
		.hljs-link_url {
			color: #e6db74;
		}

		.hljs-comment,
		.hljs-javadoc,
		.java .hljs-annotation,
		.python .hljs-decorator,
		.hljs-template_comment,
		.hljs-pi,
		.hljs-doctype,
		.hljs-deletion,
		.hljs-shebang,
		.apache .hljs-sqbracket,
		.tex .hljs-formula {
			color: #75715e;
		}

		.coffeescript .javascript,
		.javascript .xml,
		.tex .hljs-formula,
		.xml .javascript,
		.xml .vbscript,
		.xml .css,
		.xml .hljs-cdata,
		.xml .php,
		.php .xml {
			opacity: 0.5;
		}
	</style>
</head>
<body itemscope itemtype='http://schema.org/WebPage'>
	<amp-sidebar id='sidebar' layout='nodisplay'>
		<h2>Categorias</h2>
		<ul>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/back-end/'>
						<span itemprop='name'>back-end</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/cultura/'>
						<span itemprop='name'>cultura</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/data-science/'>
						<span itemprop='name'>data-science</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/design/'>
						<span itemprop='name'>design</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/devops/'>
						<span itemprop='name'>devops</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/eventos/'>
						<span itemprop='name'>eventos</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/front-end/'>
						<span itemprop='name'>front-end</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/mobile/'>
						<span itemprop='name'>mobile</span>
					</a>
				</li>
			
				<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
					<a itemprop='url' href='/amp/vagas/'>
						<span itemprop='name'>vagas</span>
					</a>
				</li>
			
		</ul>
		<h2>Veja também</h2>
		<ul>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a itemprop='url' href='http://carreira.elo7.com.br/engenharia/' target='_blank'>
					<span itemprop='name'>A engenharia</span>
				</a>
			</li>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a itemprop='url' href='http://carreira.elo7.com.br/' target='_blank'>
					<span itemprop='name'>Carreiras</span>
				</a>
			</li>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a itemprop='url' href='http://eventos.elo7.com.br/' target='_blank'>
					<span itemprop='name'>Nossos eventos</span>
				</a>
			</li>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a itemprop='url' href='https://www.elo7.com.br/' target='_blank'>
					<span itemprop='name'>Elo7</span>
				</a>
			</li>
			<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
				<a rel='external' itemprop='url' href='https://github.com/elo7/tech-blog'>Github</a>
			</li>
		</ul>
		</ul>
	</amp-sidebar>
	<header>
		<button class='sidebar-trigger' on='tap:sidebar'>☰</button>
		<a rel='home' itemprop='url' href='/amp/home/' class='logo'></a></header>

	<main itemscope itemtype='http://schema.org/Blog'>
		<article itemprop='blogPost' itemscope itemtype='http://schema.org/BlogPosting' class='post-card post-content'>
	<h1 itemprop='name' class='title'>Testes de código com Mockito (2) - Novidades da nova versão</h1>
	<div class='post-meta'>
		<p class='date'>
			Publicado em: <time datetime='21/08/2017' itemprop='datePublished'>21/08/2017</time>
			<meta itemprop='dateModified' content='21/08/2017'>
		</p>

		<article>
			
				<a data-author='ljtfreitas' itemprop='author' itemscope itemtype='http://schema.org/Person' rel='author' href='/amp/ljtfreitas/' class='author'>
					<meta itemprop='url' content='/amp/ljtfreitas'>
					<span itemprop='name' class='publisher' data-author='ljtfreitas'>@ljtfreitas</span>
					<meta itemprop='worksFor' content='Elo7 Serviços de Informática SA'>
				</a>
			
		</article>
	</div>
	<div class='content' itemprop='articleBody'>
		<p>Há algum tempo, escrevi um <a href="/testes-codigo-mockito">post</a> sobre o funcionamento e os principais recursos do <a href="http://site.mockito.org/">Mockito</a>. Na ocasião em que o post foi escrito, a versão 2 do framework ainda estava em beta, e, nesse tempo, não apenas foi <a href="https://github.com/mockito/mockito/wiki/What%27s-new-in-Mockito-2">oficialmente lançada</a> como ocorreram vários releases subsequentes (no momento em que escrevo, a última versão é a 2.7.22).</p>
<p>Neste post, vou demonstrar as principais novidades e funcionalidades dessa nova versão.</p>
<h2>Construção de mocks/proxy de objetos e classes final</h2>
<p>A principal alteração interna da versão 2 do Mockito foi a mudança da biblioteca utilizada para construção de mocks/proxificação de objetos. Para entendermos melhor essa mudança, cabe perguntar: o que raios é um proxy?</p>
<p>Sem me estender muito na explicação, &quot;proxy&quot; é um design pattern que permite colocar um objeto &quot;espelho&quot; à frente de outro, que implemente a mesma interface (interface = conjunto de métodos expostos do objeto). Esse objeto &quot;espelho&quot; (que é a instância efetivamente usada no código, funcionando como um substituto ao objeto real) é capaz de interceptar as chamadas de método realizadas, capturando os metadados do método invocado e os argumentos enviados. O proxy é capaz de realizar tratamentos específicos para algum método em particular, ou manipular os argumentos antes de invocar o método no objeto &quot;verdadeiro&quot;, e eventualmente até mesmo cancelar a invocação. Normalmente, isso é implementado utilizando algum recurso fornecido pela própria linguagem.</p>
<p>No caso do Java, proxys são um elemento fundamental em frameworks de mock. TODOS os mocks gerados pelo Mockito são proxies da classe que está sendo &quot;mockada&quot;. No meu primeiro post, eu disse que uma definição fundamental da palavra &quot;mock&quot; é que se trata de um <strong>objeto gerado em tempo de execução</strong>; em Java, isso ocorre literalmente, porque um proxy é, com efeito, bytecode gerado em tempo de execução :).</p>
<p>A API padrão do Java permite a geração de proxies <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html#getProxyClass">apenas para interfaces</a>; essa limitação era contornada com o uso de algumas coisas complicadas como instrumentação de código, manipulação de bytecode e compilação em runtime. As bibliotecas que se destacam na comunidade Java para esse tipo de trabalho são o <a href="https://github.com/cglib/cglib">CGLIB</a> e o <a href="https://github.com/jboss-javassist/javassist">javassist</a>, utilizados em vários frameworks (como o Spring e o Hibernate).</p>
<p>O Mockito, desde a primeira versão, usava o CGLIB como ferramenta de construção de mocks; a partir da versão 2, a biblioteca utilizada passou a ser o <a href="http://bytebuddy.net/">ByteBuddy</a>. As principais justificativas para a mudança são que o CGLIB, de fato, tem algumas limitações em relação ao bytecode gerado nas versões mais recentes do Java, além do ByteBuddy permitir a correção de alguns bugs de longa data do Mockito (que não eram passíveis de correções por limitações do CGLIB).</p>
<p>Mas, apesar de realmente ser uma mudança de alto impacto, o que isso muda para os nossos testes? A princípio, nada. Como a construção de mocks/proxies de objetos é feita internamente pelo Mockito, a maneira como os mocks são gerados não tem nenhum efeito direto sobre como nossos testes são escritos. Não obstante, essa mudança teve o efeito positivo de introduzir uma novidade, ainda que em caráter experimental: permitir mockar classes <em>final</em>! :)</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Sample</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">bla</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"bla"</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SampleTest</span> </span>{

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
        Sample sampleMock = Mockito.mock(Sample.class);
        when(sampleMock.bla()).thenReturn(<span class="hljs-string">"foo"</span>);

        String output = sampleMock.bla();

        assertEquals(<span class="hljs-string">"foo"</span>, output);
    }
}
</code></pre>
<p>Nas versões 1.x do Mockito, o teste acima simplesmente não funcionaria, pois seria impossível mockar a classe Sample ou mesmo o método &quot;bla()&quot;. Isto porquê o mecanismo de proxy do CGLIB se baseia em criar, em tempo de execução, uma subclasse do objeto proxificado; como não é possível criar uma subclasse de uma classe <em>final</em>, ou sobrescrever um método marcado como <em>final</em>, não era possível implementar um teste como o do exemplo acima apenas com o Mockito. Para contornar essa limitação, uma biblioteca muito utilizada é o <a href="http://powermock.github.io/">PowerMock</a> (com a extensão <a href="http://www.javadoc.io/doc/org.powermock/powermock-api-mockito/1.6.4">PowerMockito</a>), que tem como premissa &quot;testar o não-testável&quot;, incluindo <a href="https://github.com/powermock/powermock/wiki/mockfinal">classes e métodos final</a> como no exemplo.</p>
<p>Como dito antes, o mock de classes/métodos <em>final</em> está em fase de testes no Mockito. Para habilitá-la, você deve ativar um mecanismo semelhante ao <a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html">ServiceLoader</a> do Java:</p>
<ul>
<li>no seu classpath de teste, crie uma pasta chamada mockito-extensions, e dentro dela um arquivo chamado org.mockito.plugins.MockMaker (se o seu projeto utiliza Maven ou Gradle, por exemplo, o local desse arquivo seria &quot;src/test/resources/mockito-extensions/org.mockito.plugins.MockMaker&quot;)</li>
<li>o conteúdo desse arquivo deve ser uma única linha contendo: <strong>mock-maker-inline</strong></li>
</ul>
<p>A presença desse arquivo irá sobrescrever o <a href="http://static.javadoc.io/org.mockito/mockito-core/2.7.22/org/mockito/plugins/MockMaker.html">MockMaker</a> padrão utilizado pelo Mockito. Essa interface foi projetada para servir como um ponto de extensão do framework, permitindo customizar a maneira como os mocks são criados.</p>
<p>Com a configuração acima, o Mockito irá utilizar uma implementação especialmente projetada para usar uma combinação de subclasses e instrumentação (através de um Java Agent). Mas não se preocupe: essas complexidades de baixo nível são invisíveis para o teste, e finalmente seremos capazes de mockar nossas classes e métodos <em>final</em> (como o exemplo acima) sem recorrer a outras bibliotecas!</p>
<p>Uma maneira simplificada de utilizar esse recurso é incluir a dependência <em>mockito-inline</em> no seu classpath. Esse artefato irá configurar o arquivo org.mockito.plugins.MockMaker como demonstrado acima.</p>
<p>Para mais detalhes: <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/Mockito.html#Mocking_Final">Mock the unmockable</a></p>
<h2>Stubs não utilizados</h2>
<p>Um dos objetivos da nova versão do Mockito é ajudar os desenvolvedores a escrever testes melhores. Um dos pontos de atenção para manter os testes limpos e fáceis de entender é evitar código não utilizado, como configurações de mocks que não são usados na execução do programa. Vejamos um exemplo:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dictionary</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Translator translator;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Dictionary</span><span class="hljs-params">(Translator translator)</span> </span>{
        <span class="hljs-keyword">this</span>.translator = translator;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">get</span><span class="hljs-params">(String word)</span> </span>{
        <span class="hljs-keyword">return</span> translator.translate(word);
    }
}
</code></pre>
<p>E nosso teste:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DictionaryTest</span> </span>{

    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> Translator translator;

    <span class="hljs-meta">@InjectMocks</span>
    <span class="hljs-keyword">private</span> Dictionary dictionary;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
        String word = <span class="hljs-string">"ola"</span>;

        when(translator.translate(word)).thenReturn(<span class="hljs-string">"hello"</span>);

        String output = dictionary.get(word);

        assertNotNull(output);
    }
}
</code></pre>
<p>Nossa classe Dictionary, no método &quot;get&quot;, utiliza uma instância do Translator (uma interface; a implementação do Translator não é relevante para nós) para &quot;traduzir&quot; a palavra enviada como parâmetro. Utilizamos o Mockito para configurar o método &quot;translate&quot; do Translator, para devolver a String &quot;hello&quot; quando o método for invocado com a palavra &quot;word&quot;. O teste apenas verifica se a resposta do método é não-nula (um teste frágil mas atende nosso exemplo por hora). O teste acima passaria sem problema. Mas, e se nosso código fosse modificado da seguinte forma:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dictionary</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Translator translator;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Dictionary</span><span class="hljs-params">(Translator translator)</span> </span>{
        <span class="hljs-keyword">this</span>.translator = translator;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">get</span><span class="hljs-params">(String word)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ooops"</span>;
    }
}
</code></pre>
<p>Perceba que o método &quot;get&quot; não utiliza mais o Translator. Este seria um bug que nosso teste não detectaria, por dois motivos: 1) o teste apenas confirma que a saída do método é uma String não-nula, o que continua acontecendo, e 2) o teste não verifica se o mock foi efetivamente invocado (usando o Mockito.verify). O ponto que quero ressaltar aqui é que a detecção do bug, nesse caso, <strong>depende do teste estar bem escrito</strong>. Isso pode parecer apenas senso comum, mas é muito fácil deixar passar esse tipo de detalhe, às vezes por simples desatenção momentânea, por não realizarmos completamente o ciclo do TDD (red-green-refactor), ou por desconhecimento de eventuais recursos dos frameworks envolvidos.</p>
<p>Por outro lado, a mudança que realizamos acima também poderia ser uma refatoração válida: digamos que nosso Dictionary realmente não irá mais utilizar o Translator e irá implementar sua lógica interna de outro modo. Em nosso teste, teríamos um mock não utilizado, com a configuração desnecessária poluindo o código. Agora, o Mockito é capaz de detectar esse tipo de situação.</p>
<p>Se executarmos novamente nosso DictionaryTest (após a mudança acima na classe Dictionary), teríamos como saída do teste:</p>
<p><div class='post-image'><amp-img on='tap:lightbox-0' role='button' tabindex='0' src='../../images/testes-codigo-mockito-2-1.png' layout='fixed' height='89' width='272' alt='mockito-2-output-unused-stub'></amp-img><amp-image-lightbox id='lightbox-0' layout='nodisplay'></amp-image-lightbox></div></p>
<p>O teste irá passar, mas será exibido no relatório do Junit a seguinte mensagem:</p>
<pre class="highlight"><code class="hljs undefined">org.mockito.exceptions.misusing.UnnecessaryStubbingException:
Unnecessary stubbings detected in test class: DictionaryTest
Clean &amp; maintainable test code requires zero unnecessary code.
Following stubbings are unnecessary (click to navigate to relevant line of code):
  1. -&gt; at com.elo7.mockito.sample.DictionaryTest.test(DictionaryTest.java:25)
Please remove unnecessary stubbings or use 'silent' option. More info: javadoc for UnnecessaryStubbingException class.
    at org.mockito.internal.runners.StrictRunner.run(StrictRunner.java:49)
    at org.mockito.junit.MockitoJUnitRunner.run(MockitoJUnitRunner.java:161)
    at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:86)
    at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)
    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:459)
    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:678)
    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:382)
    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:192)

</code></pre>
<p>Além da mensagem bastante explicativa, o erro também inclui a linha da classe com a configuração desnecessária do mock. Reforçando: essa mensagem de &quot;stubs não utilizados&quot; será exibida <strong>apenas se o teste passar</strong> (essa decisão foi justificada pela equipe do Mockito tendo em mente que, se o teste falhar, exibir a mensagem de falha em conjunto com o erro relativo aos stubs poderia gerar confusão ao usuário).</p>
<p>Então, agora temos o recurso do Mockito para nos ajudar a limpar o código de teste (se for o caso), indicando configurações de mocks (os tais &quot;stubs&quot;) não utilizados. Mas e se o teste ainda não estiver passando? Um problema em potencial poderia ser uma eventual configuração incorreta do mock; ou seja, o mock está sendo utilizado no código mas não da maneira como foi &quot;stubado&quot;. Digamos, algo assim:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dictionary</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Translator translator;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Dictionary</span><span class="hljs-params">(Translator translator)</span> </span>{
        <span class="hljs-keyword">this</span>.translator = translator;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">get</span><span class="hljs-params">(String word)</span> </span>{
        <span class="hljs-keyword">return</span> translator.translate(word);
    }
}
</code></pre>
<p>Novamente, nosso teste:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DictionaryTest</span> </span>{

    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> Translator translator;

    <span class="hljs-meta">@InjectMocks</span>
    <span class="hljs-keyword">private</span> Dictionary dictionary;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
        String word = <span class="hljs-string">"ola"</span>;

        when(translator.translate(word)).thenReturn(<span class="hljs-string">"hello"</span>);

        String output = dictionary.get(<span class="hljs-string">"oi"</span>);

        assertNotNull(output);
    }
}
</code></pre>
<p>O teste acima irá falhar. A resposta do método &quot;get&quot; do Dictionary será <em>null</em>, porque configuramos o Translator para devolver &quot;hello&quot; <strong>somente</strong> quando o método &quot;translate&quot; for invocado com o parâmetro &quot;ola&quot;, o que não foi o caso já que enviamos a String &quot;oi&quot;. O Mockito 2 também é capaz de nos auxiliar nessa situação, indicando que o mock foi utilizado, mas não da maneira como foi configurado. Ao rodar o teste acima, a seguinte mensagem será exibida no console:</p>
<pre class="highlight"><code class="hljs java">[MockitoHint] DictionaryTest.test (see javadoc <span class="hljs-keyword">for</span> MockitoHint):
[MockitoHint] <span class="hljs-number">1</span>. Unused... -&gt; at com.elo7.mockito.sample.DictionaryTest.test(DictionaryTest.java:<span class="hljs-number">25</span>)
[MockitoHint]  ...args ok? -&gt; at com.elo7.mockito.sample.Dictionary.get(Dictionary.java:<span class="hljs-number">12</span>)
</code></pre>
<p>Nessa mensagem, o Mockito incluiu o ponto do código onde o mock é configurado, e o ponto onde está sendo utilizado (incorretamente ou, no mínimo, de modo diferente do que foi configurado). Esse relatório é extremamente útil, principalmente para testes mais complexos (casos em que os programadores, invariavelmente, debugam o código para encontrar o problema). Ao contrário do exemplo anterior, esse relatório de &quot;stubs mal utilizados&quot;, se for o caso, será exibido no console (fora da saída do Junit) <strong>somente quando o teste falhar</strong>.</p>
<p>Caso prefira não utilizar a verificação de &quot;stubs não utilizados/mal utilizados&quot; (habilitado por padrão), você pode usar o Mockito no modo &quot;silencioso&quot;:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.Silent.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DictionaryTest</span> </span>{
}
</code></pre>
<h2>Matchers do Hamcrest</h2>
<p>Uma dor de cabeça recorrente das versões 1.x do Mockito era o conflito de versões do <a href="http://hamcrest.org/JavaHamcrest/">Hamcrest</a>, uma biblioteca de <em>argument matchers</em>. Esses conflitos ocorriam porque o Mockito dependia explicitamente do Hamcrest (em função do método <a href="http://static.javadoc.io/org.mockito/mockito-core/1.10.19/org/mockito/Matchers.html#argThat(org.hamcrest.Matcher)">Matchers.argThat</a>, que aceita como parâmetro um matcher), mas as classes principais do Hamcrest são carregadas dentro do jar do JUnit (para serem utilizadas no método <a href="http://junit.org/junit4/javadoc/latest/org/junit/Assert.html#assertThat(T,%20org.hamcrest.Matcher)">Assert.assertThat</a>), o que eventualmente gerava um pequeno e clássico &quot;classpath hell&quot; (já que o Mockito dependia de uma versão e o JUnit de outra).</p>
<p>Essa dependência foi removida e o método <em>Matchers.argThat</em> (que recebia como parâmetro um matcher do Hamcrest) foi depreciado. Se quiser utilizar o Hamcrest no seu projeto, você mesmo deve incluí-lo no seu classpath de testes, e utilizar a nova classe <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/hamcrest/MockitoHamcrest.html">MockitoHamcrest</a>.</p>
<p>A respeito da depreciação do método <em>Matchers.argThat</em>: na verdade, a classe Matchers foi inteiramente depreciada. Essa classe era extendida pela classe Mockito (a classe principal do framework), que na versão 2, passa a extender a classe <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/ArgumentMatcher.html">ArgumentMatchers</a>.</p>
<h2>Answers.RETURNS_SELF</h2>
<p>No meu post anterior, explorei a abstração <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/stubbing/Answer.html">Answer</a> e as várias opções possíveis para configurar a resposta dos métodos de um mock. Na versão 2, o Mockito introduziu uma nova opção chamada <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/Mockito.html#RETURNS_SELF">RETURNS_SELF</a>, que é particularmente útil para testes envolvendo Builders.</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeTest</span> </span>{

    <span class="hljs-meta">@Mock</span>(answer = Answers.RETURNS_SELF)
    <span class="hljs-keyword">private</span> Builder builder;

}
</code></pre>
<p>O comportamento dessa resposta é: se algum método <strong>não configurado</strong> desse mock for invocado,</p>
<ul>
<li>Se o retorno do método for algum tipo <strong>igual à classe ou superclasse</strong> do mock, retorna a <strong>mesma instância</strong> do mock;</li>
<li>Para qualquer outro caso, seguirá o mesmo comportamento da configuração padrão do Mockito (<a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/Mockito.html#RETURNS_DEFAULTS">RETURNS_DEFAULTS</a>).</li>
</ul>
<p>Considere o exemplo abaixo, extraído da documentação:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpBuilder</span> </span>{

    <span class="hljs-keyword">private</span> String uri;

    <span class="hljs-keyword">private</span> List&lt;String&gt; headers;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HttpBuilder</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.headers = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> HttpBuilder <span class="hljs-title">withUrl</span><span class="hljs-params">(String uri)</span> </span>{
        <span class="hljs-keyword">this</span>.uri = uri;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> HttpBuilder <span class="hljs-title">withHeader</span><span class="hljs-params">(String header)</span> </span>{
        <span class="hljs-keyword">this</span>.headers.add(header);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">request</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> uri + headers.toString();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpRequestWithHeaders</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpBuilder builder;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HttpRequestWithHeaders</span><span class="hljs-params">(HttpBuilder builder)</span> </span>{
        <span class="hljs-keyword">this</span>.builder = builder;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">request</span><span class="hljs-params">(String uri)</span> </span>{
        <span class="hljs-keyword">return</span> builder.withUrl(uri)
                .withHeader(<span class="hljs-string">"Content-type: application/json"</span>)
                .withHeader(<span class="hljs-string">"Authorization: Bearer"</span>)
                .request();
    }
}
</code></pre>
<p>E o teste:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeTest</span> </span>{

    <span class="hljs-meta">@Mock</span>(answer = Answers.RETURNS_SELF)
    <span class="hljs-keyword">private</span> HttpBuilder builder;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
          HttpRequesterWithHeaders requester = <span class="hljs-keyword">new</span> HttpRequestWithHeaders(builder);

          String response = <span class="hljs-string">"StatusCode: 200"</span>;

        <span class="hljs-comment">//permite configurar apenas o método "request" do mock, pois cada método utilizado devolve a mesma instância</span>
          when(builder.request()).thenReturn(response);

          assertThat(requester.request(<span class="hljs-string">"URI"</span>)).isEqualTo(response);
    }
}
</code></pre>
<p>O mock de Builders já era relativamente possível usando a answer <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/Mockito.html#RETURNS_DEEP_STUBS">RETURNS_DEEP_STUBS</a> (que expliquei com maiores detalhes no post anterior). A principal diferença é que o RETURNS_DEEP_STUBS devolve um <strong>novo mock</strong> para cada método invocado, de modo que você precisaria navegar pela cadeia de invocações caso quisesse mockar um método específico. Com o RETURNS_SELF, isso não é necessário.</p>
<p>Como ponto de atenção, reforço o que foi explicado acima: essa answer terá efeito <strong>apenas para os métodos que devolvem o mesmo tipo da classe mockada</strong>.</p>
<h2>Spy</h2>
<p>A nova versão do Mockito traz uma mudança muito interessante sobre os <em>spies</em> (se você não os conhece, meu <a href="/testes-codigo-mockito/">post anterior</a> explica detalhadamente o que são &quot;objetos espiões&quot; e como utilizá-los). Agora, é possível &quot;espiar&quot; uma classe abstrata, o que antes não era possível. Considere o exemplo abaixo, com uma implementação do pattern <a href="https://pt.wikipedia.org/wiki/Template_Method">Template Method</a>. A idéia desse padrão é &quot;definir o esqueleto de um algoritmo, delegando alguns passos para as subclasses&quot;.</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentGenerator</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">public</span> Document <span class="hljs-title">generate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// esse método define a código-base da geração de documentos, usando os métodos implementados nas subclasses</span>
        StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder();

        builder.append(header())
               .append(body())
               .append(footer());

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Document(builder.toString());
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">header</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">body</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">footer</span><span class="hljs-params">()</span></span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HtmlDocumentGenerator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DocumentGenerator</span> </span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">header</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Gera o cabeçalho do documento no formato HTML</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">body</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Gera o corpo do documento no formato HTML</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">footer</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Gera o rodapé do documento no formato HTML</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XmlDocumentGenerator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DocumentGenerator</span> </span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">header</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Gera o cabeçalho do documento no formato XML</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">body</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Gera o cabeçalho do documento no formato XML</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">footer</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Gera o cabeçalho do documento no formato XML</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }
}
</code></pre>
<p>Suponhamos que desejamos testar o método &quot;generate&quot; da classe DocumentGenerator, pois esee método representa a geração do documento completa (de qualquer tipo). Uma idéia válida seria usarmos um <em>partial mock</em> do DocumentGenerator, mockando os métodos auxiliares do algoritmo (no caso, &quot;header()&quot;, &quot;body()&quot; e &quot;footer()&quot;). Poderíamos utilizar o <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/Spy.html">@Spy</a> do Mockito, que nos permitir usar a implementação real do método &quot;generate&quot; e configurarmos os outros:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentGeneratorTest</span> </span>{

    <span class="hljs-meta">@Spy</span>
    <span class="hljs-keyword">private</span> DocumentGenerator documentGenerator;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
        doReturn(<span class="hljs-string">"[header]"</span>).when(documentGenerator).header();
        doReturn(<span class="hljs-string">"[body]"</span>).when(documentGenerator).body();
        doReturn(<span class="hljs-string">"[footer]"</span>).when(documentGenerator).footer();

        Document document = documentGenerator.generate();

        assertEquals(<span class="hljs-string">"[header][body][footer]"</span>, document.toString());
    }
}
</code></pre>
<p>No Mockito 1.x, essa configuração não vai funcionar, porque <strong>não é possível criar um spy a partir de uma classe abstrata</strong>. A &quot;solução&quot; seria criar um &quot;objeto stub&quot;, que extende DocumentGenerator, para utilizarmos no teste:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentGeneratorTest</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DocumentGenerator documentGenerator = <span class="hljs-keyword">new</span> DummyDocumentGenerator();

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
        Document document = documentGenerator.generate();

        assertEquals(<span class="hljs-string">"[header][body][footer]"</span>, document.toString());
    }

    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DummyDocumentGenerator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DocumentGenerator</span> </span>{

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">header</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"[header]"</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">body</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"[body]"</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">footer</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"[footer]"</span>;
        }

    }
}
</code></pre>
<p>No Mockito 2.x, podemos criar um spy a partir de uma classe abstrata, e o teste inicial (exemplo anterior) rodaria sem problemas. No exemplo, a criação foi feita com a anotação @Spy; nesse caso, a única restrição é que a classe abstrata <strong>deve ter um construtor padrão (sem argumentos)</strong>. Se não for o caso, você ainda pode utilizar a <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/Mockito.html#spying_abstract_classes">API programática do Mockito</a>:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeAbstractType</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String arg;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> otherArg;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SomeAbstractType</span><span class="hljs-params">(String arg, <span class="hljs-keyword">int</span> otherArg)</span> </span>{
        <span class="hljs-keyword">this</span>.arg = arg;
        <span class="hljs-keyword">this</span>.otherArg = otherArg;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeAbstractTypeTest</span> </span>{

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">anyTest</span><span class="hljs-params">()</span> </span>{
        SomeAbstractType spy = mock(SomeAbstractType.class, withSettings().useConstructor(<span class="hljs-string">"arg1"</span>, <span class="hljs-number">123</span>).defaultAnswer(Answers.CALLS_REAL_METHODS));
    }
}
</code></pre>
<h2>Verificação de métodos</h2>
<p>A verificação de métodos dos mocks (realizada pelo método <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/Mockito.html#verify(T)">Mockito.verify</a>) consiste em <strong>confirmar que os mocks foram invocados adequadamente</strong>, e é extremamente importante em alguns cenários de teste (em outros, nem tanto). Uma melhoria introduzida na versão 2 do Mockito é a possibilidade de verificação &quot;lazy&quot;. Abaixo, um exemplo dessa funcionalidade:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String email;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(String name, String email)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.email = email;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getEmail</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> email;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepository</span> </span>{

    <span class="hljs-function">User <span class="hljs-title">save</span><span class="hljs-params">(User user)</span></span>;

}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserEmailSender</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendTo</span><span class="hljs-params">(User user)</span></span>;

}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserEmailSender userEmailSender;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserService</span><span class="hljs-params">(UserRepository userRepository, UserEmailSender userEmailSender)</span> </span>{
        <span class="hljs-keyword">this</span>.userRepository = userRepository;
        <span class="hljs-keyword">this</span>.userEmailSender = userEmailSender;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">persist</span><span class="hljs-params">(User user)</span> </span>{
        <span class="hljs-comment">/* aqui vamos usar o UserRepository para persistir o usuário na nossa base de dados,
         e o UserEmailSender para enviar um e-mail de boas vindas.
         Mas o código ainda não está implementado! */</span>

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }
}
</code></pre>
<p>Nosso teste:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceTest</span> </span>{

    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository;

    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> UserEmailSender userEmailSender;

    <span class="hljs-meta">@InjectMocks</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shouldCreateNewUser</span><span class="hljs-params">()</span> </span>{
        User user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">"Tiago de Freitas Lima"</span>, <span class="hljs-string">"tiago.lima@elo7.com"</span>);
        User newUser = <span class="hljs-keyword">new</span> User(<span class="hljs-number">1l</span>, <span class="hljs-string">"Tiago de Freitas Lima"</span>, <span class="hljs-string">"tiago.lima@elo7.com"</span>);

        when(userRepository.save(user)).thenReturn(newUser);

        User persistedUser = userService.persist(user);

        verify(userRepository).save(user);
        verify(userEmailSender).sendTo(newUser);
    }

}
</code></pre>
<p>Implementamos nosso teste pensando no comportamento esperado do método UserService.persist; enviamos um usuário, queremos que ele seja persistido no repositório de dados e que seja enviado um email ao usuário criado. O teste irá falhar, pois o código ainda não foi implementado. E irá falhar na primeira verificação:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceTest</span> </span>{

    <span class="hljs-comment">//...código omitido</span>

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shouldCreateNewUser</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">//...código omitido</span>
        verify(userRepository).save(user); <span class="hljs-comment">// falha aqui - o método do mock não foi invocado</span>
        verify(userEmailSender).sendTo(newUser); <span class="hljs-comment">// essa verificação não é executada</span>
    }
}
</code></pre>
<p>O erro no JUnit, indicando a verificação do Mockito que falhou:</p>
<pre class="highlight"><code class="hljs java">Wanted but not invoked:
userRepository.save(
    com.elo7.mockito.sample.User@<span class="hljs-number">222545</span>dc
);
-&gt; at com.elo7.mockito.sample.UserServiceTest.shouldCreateNewUser(UserServiceTest.java:<span class="hljs-number">37</span>)
Actually, there were zero interactions with <span class="hljs-keyword">this</span> mock.
</code></pre>
<p>Ao implementarmos um teste dessa forma (<a href="http://www.extremeprogramming.org/rules/testfirst.html">test-first</a>), seria útil visualizarmos todas as interações de mocks que ainda não estão implementadas no código. No exemplo acima, seria de muito valor que o Mockito nos informasse, no seu relatório de erro, que tanto o UserRepository quanto o UserEmailSender não estão sendo utilizados. No Mockito 2, isso é possível usando uma <a href="https://github.com/junit-team/junit4/wiki/rules">@Rule</a> especial chamada <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/junit/VerificationCollector.html">VerificationCollector</a>:</p>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceTest</span> </span>{

    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository;

    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> UserEmailSender userEmailSender;

    <span class="hljs-meta">@InjectMocks</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Rule</span>
    <span class="hljs-keyword">public</span> VerificationCollector collector = MockitoJUnit.collector(); <span class="hljs-comment">//basta declarar a rule</span>

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shouldCreateNewUser</span><span class="hljs-params">()</span> </span>{
        User user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">"Tiago de Freitas Lima"</span>, <span class="hljs-string">"tiago.lima@elo7.com"</span>);
        User newUser = <span class="hljs-keyword">new</span> User(<span class="hljs-number">1l</span>, <span class="hljs-string">"Tiago de Freitas Lima"</span>, <span class="hljs-string">"tiago.lima@elo7.com"</span>);

        when(userRepository.save(user)).thenReturn(newUser);

        userService.persist(user);

        verify(userRepository).save(user); <span class="hljs-comment">//essa verificação irá falhar, mas a execução do teste vai continuar</span>
        verify(userEmailSender).sendTo(newUser); <span class="hljs-comment">//essa verificação também falhará, mas novamente a execução não será interrompida</span>
    }
}
</code></pre>
<p>Agora, na saída no JUnit, o erro lançado pelo Mockito irá indicar os dois mocks não utilizados:</p>
<pre class="highlight"><code class="hljs java">org.mockito.exceptions.base.MockitoAssertionError: There were multiple verification failures:
<span class="hljs-number">1</span>. Wanted but not invoked:
userRepository.save(
    com.elo7.mockito.sample.User@<span class="hljs-number">564f</span>abc8
);
-&gt; at com.elo7.mockito.sample.UserServiceTest.shouldCreateNewUser(UserServiceTest.java:<span class="hljs-number">39</span>)
Actually, there were zero interactions with <span class="hljs-keyword">this</span> mock.
<span class="hljs-number">2</span>. Wanted but not invoked:
userEmailSender.sendTo(
    com.elo7.mockito.sample.User@<span class="hljs-number">436813f</span>3
);
-&gt; at com.elo7.mockito.sample.UserServiceTest.shouldCreateNewUser(UserServiceTest.java:<span class="hljs-number">40</span>)
Actually, there were zero interactions with <span class="hljs-keyword">this</span> mock.
</code></pre>
<p>Um detalhe importante do exemplo acima: para fins de exemplo, não inclui nenhum <em>assert</em>. Supondo que eu fizesse alguma asserção e ela falhasse (por exemplo, <em>assertNotNull</em> no retorno do método), os eventuais problemas de verificação <strong>não seriam exibidos</strong>, apenas a falha do teste. Então, os erros da verificação &quot;lazy&quot;, gerados pelo Mockito <strong>após</strong> o teste, serão exibidos apenas se não ocorrer nenhum outro problema.</p>
<h2>E mais mudanças...</h2>
<ul>
<li>
<p>A nova versão é compatível apenas com Java 6 ou superior (a versão 1.x é compatível com Java 5)</p>
</li>
<li>
<p>Os matchers <em>anyX()</em> (anyString(), anyInt(), etc) e <em>any(AlgumTipo.class)</em> passam a <strong>rejeitar valores nulos</strong>. Exemplos:</p>
</li>
</ul>
<pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Translator</span> </span>{

    <span class="hljs-function">String <span class="hljs-title">translate</span><span class="hljs-params">(String word)</span></span>;

}

<span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeTest</span> </span>{

    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> Translator translator;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
        translator.translate(<span class="hljs-keyword">null</span>);

        verify(translator).translate(anyString()); <span class="hljs-comment">// falha -&gt; null não é "qualquer String"</span>
        verify(translator).translate(any()); <span class="hljs-comment">// sucesso -&gt; null é "qualquer"</span>
    }
}
</code></pre>
<ul>
<li>
<p>O método <em>getArgumentAt</em>, da classe <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/invocation/InvocationOnMock.html">InvocationOnMock</a> foi renomeado e teve sua assinatura alterada para inferir o tipo de retorno de forma implícita (ao invés de receber um argumento do tipo Class). Essa mudança é muito importante caso você implemente respostas customizadas. Também foram criadas novas <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/stubbing/Answer1.html">Answers</a> para métodos com múltiplos argumentos.</p>
</li>
<li>
<p>Para fins de depuração, caso você queira visualizar todas as invocações do seu mock, você pode utilizar o novo método <a href="http://static.javadoc.io/org.mockito/mockito-core/2.8.47/org/mockito/MockingDetails.html#printInvocations()">MockingDetails.printInvocations</a>:</p>
</li>
</ul>
<pre class="highlight"><code class="hljs java"><span class="hljs-meta">@RunWith</span>(MockitoJUnitRunner.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeTest</span> </span>{

    <span class="hljs-meta">@Mock</span>
    <span class="hljs-keyword">private</span> Translator translator;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
        translator.translate(<span class="hljs-string">"ola"</span>);

        System.out.println(Mockito.mockingDetails(translator).printInvocations());
    }
}
</code></pre>
<p>A saída no console:</p>
<pre class="highlight"><code class="hljs java">[Mockito] Interactions of: translator
 <span class="hljs-number">1</span>. translator.translate(<span class="hljs-string">"ola"</span>);
  -&gt; at com.elo7.mockito.sample.SomeTest.test(SomeTest.java:<span class="hljs-number">17</span>)
</code></pre>
<ul>
<li>Se você está utilizando o Mockito no Android, a versão 2 traz algumas customizações de geração de bytecode específicas para a JVM do Android. Para utilizar, basta importar o artefato <em>mockito-android</em>.</li>
</ul>
<h2>Conclusão</h2>
<p>O Mockito é um dos frameworks de mocks mais utilizados na linguagem Java, muito devido à simplicidade na sua utilização e grande número de recursos. A versão 2.x manteve essa linha de implementação, além de trazer novas e interessantes funcionalidades para ajudar os desenvolvedores a escrever mais e melhores testes. Nesse post, cobri as principais mudanças e novidades da nova versão. Espero que tenha gostado! Em caso de dúvidas ou qualquer outra coisa, sinta-se à vontade para usar a caixa de comentários!</p>

		<section class='share'>
			<a href='https://www.facebook.com/dialog/share?app_id=644444999041914&href=https://engenharia.elo7.com.br/amp/testes-codigo-mockito-2/&display=popup' rel='noopener' target='_blank' class='link-share facebook' title='Clique para compartilhar no Facebook'>
				Compartilhar no facebook
			</a>
			<a href='https://twitter.com/intent/tweet?text=Testes de código com Mockito (2) - Novidades da nova versão&url=https://engenharia.elo7.com.br/amp/testes-codigo-mockito-2/&hashtags=elo7tech' rel='noopener' target='_blank' class='link-share twitter' title='Clique para compartilhar no Twitter'>
				Compartilhar no twitter
			</a>
		</section>
	</div>
	<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"> <!--Change for a post image-->
		<link href="/images/ico/elo7.png" itemprop="url"/>
		<meta itemprop='width' content='100px'/>
		<meta itemprop='height' content='100px'/>
	</span>

	<meta itemprop='headline' content='Há algum tempo, escrevi sobre o funcionamento e os principais recursos do Mockito. Neste post, vamos conhecer as novidades da nova versão do framework.'/>
	<span itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
		<meta itemprop='name' content='Elo7 Tech'/>
		<meta itemprop="url" content='https://engenharia.elo7.com.br'/>
		<span itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
			<link href="https://images.elo7.com.br/assets/v3/desktop/png/logo-elo7.png" itemprop="url"/>
			<meta itemprop='width' content='100px'/>
			<meta itemprop='height' content='100px'/>
		</span>
	</span>
	<meta itemprop='mainEntityOfPage' content='Elo7 Serviços de Informática SA'/>
</article>
	</main>
	<footer itemscope itemtype='http://schema.org/Organization'>
		<a rel='home' itemprop='url' href='/amp/home/'>engenharia.elo7.com.br © 2017</a>
		<meta itemprop='name' content='Elo7 Serviços de Informática SA'/>
		<section class='footer-social'>
			<a title='Github do Elo7' rel='external' itemprop='url' href='https://github.com/elo7' target='_blank' class='github'>Github do Elo7</a>
			<a title='Twitter do Elo7' rel='external' itemprop='url' href='https://twitter.com/elo7tech' target='_blank' class='twitter'>Twitter do Elo7</a>
			<a title='RSS do Elo7' rel='external' itemprop='url' href='https://engenharia.elo7.com.br/rss.xml' target='_blank' class='rss'>RSS do Elo7</a>
			<a title='Newsletter do Elo7' rel='external' itemprop='url' href='http://eepurl.com/cVUwvH' target='_blank' class='email'>Newsletter do Elo7</a>
		</section>
	</footer>
	<amp-analytics type='googleanalytics'>
		<script type='application/json'>
			{
				"vars": {
					"account": "UA-3692628-29"
				},
				"triggers": {
					"trackPageview": {
						"on": "visible",
						"request": "pageview"
					}
				}
			}
		</script>
	</amp-analytics>
</body>
</html>
