<!doctype html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Segundo post da série &#x27;Terraformando Tudo&#x27;, que conta a nossa trajetória em busca da codificação da nossa infraestrutura. Neste post contamos o que fizemos para mitigar possíveis desastres e como controlamos N desenvolvedores alterando N Terraform configurations. Vamos lá?">
	<meta name="google-site-verification" content="NqCILBTY8B8P-r_KF8BSZKH9kUQgQOEbXJvEMaB33vw">
	<meta name="google-site-verification" content="cKh-stJM3_ENNfMjaBIIyYiDgMXZFpRkoH8eQTcPwhM" />
	<meta name="theme-color" content="#FDC24F">
	<meta name="keywords" content="Elo7,tecnologia,post,desenvolvimento,blog,devops,terraform,iac,infrastructure as code,infra">
	<meta name="language" content="pt-br">
	<meta name="title" content="Elo7 Tech - Terraformando tudo - parte 2">
	<meta name="apple-mobile-web-app-title" content="Elo7 Tech - Terraformando tudo - parte 2">
	<meta name="mobile-web-app-capable" content="yes">

	<meta property="fb:app_id" content="644444999041914">
	<meta property="fb:admins" content="100003324447975">

	<meta property="og:site_name" content="Elo7 Tech">
	<meta property="og:image" content="https://engenharia.elo7.com.br/images/ico/elo7.png">
	<meta property="og:type" content="website">
	<meta property="og:title" content="Elo7 Tech - Terraformando tudo - parte 2">
	<meta property="og:url" content="https://engenharia.elo7.com.br/terraformando-tudo-2/">
	<meta property="og:description" content="Segundo post da série &#x27;Terraformando Tudo&#x27;, que conta a nossa trajetória em busca da codificação da nossa infraestrutura. Neste post contamos o que fizemos para mitigar possíveis desastres e como controlamos N desenvolvedores alterando N Terraform configurations. Vamos lá?">

	<meta name="twitter:widgets:csp" content="on">
	<meta name="twitter:card" content="summary_large_image">

	<meta property="twitter:title" content="Elo7 Tech - Terraformando tudo - parte 2">
	<meta property="twitter:domain" content="https://engenharia.elo7.com.br">
	<meta property="twitter:url" content="https://engenharia.elo7.com.br/terraformando-tudo-2/">
	<meta property="twitter:description" content="Segundo post da série &#x27;Terraformando Tudo&#x27;, que conta a nossa trajetória em busca da codificação da nossa infraestrutura. Neste post contamos o que fizemos para mitigar possíveis desastres e como controlamos N desenvolvedores alterando N Terraform configurations. Vamos lá?">
	<meta property="twitter:image" content="https://engenharia.elo7.com.br/images/ico/elo7.png">

	<link rel="canonical" href="https://engenharia.elo7.com.br/terraformando-tudo-2/">
	
		<link rel='amphtml' href='https://engenharia.elo7.com.br/amp/terraformando-tudo-2/' />
	

	<title>Elo7 Tech - Terraformando tudo - parte 2</title>
	<link rel="stylesheet" href="/reset.css">
	<link rel="stylesheet" href="/main.css">
	<link rel="stylesheet" href="/posts.css">
	<link rel="stylesheet" href="/post.css">
	<link rel="icon" href="/images/favicon/favicon-16.png" sizes="16x16">
	<link rel="icon" href="/images/favicon/favicon-32.png" sizes="32x32">
	<link rel="icon" href="/images/favicon/favicon-48.png" sizes="48x48">
	<link rel="icon" href="/images/favicon/favicon-64.png" sizes="64x64">
	<link rel="icon" href="/images/favicon/favicon-96.png" sizes="96x96">
	<link rel="icon" href="/images/favicon/favicon-128.png" sizes="128x128">
	<link rel="icon" href="/images/favicon/favicon-160.png" sizes="160x160">
	<link rel="icon" href="/images/favicon/favicon-192.png" sizes="192x192">
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="/images/favicon/favicon-180.png">
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/favicon/favicon-152.png">
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/favicon/favicon-144.png">
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/favicon/favicon-120.png">
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/favicon/favicon-114.png">
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/favicon/favicon-76.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/favicon/favicon-72.png">
	<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/images/favicon/favicon-60.png">
	<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/favicon/favicon-57.png">
	<link rel="apple-touch-icon-precomposed" href="/images/favicon/favicon-precomposed.png">
	<script>window.addEventListener("error", window.__e=function f(e){f.q=f.q||[];f.q.push(e)});</script>
	<script src="/js/vendor/async-define.js"></script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" data-env="production" data-ga-code="UA-3692628-29">
	<header class="left-pane">
		<div class="logo-container">
			<a rel="home" itemprop="url" href="/" class="logo">Tech Blog Elo7</a>
		</div>
		<div itemscope itemtype="http://schema.org/SiteNavigationElement" class="navigation">
			<input id="categories-switch" type="checkbox" class="categories-switch">
			<label for="categories-switch" class="selectable">
				<h2 class="nav-title">Categorias</h2>
			</label>
			<nav aria-label="Navegue pelas categorias do nosso blog" class="nav-list nav-category">
				
					<a itemprop="url" href="/back-end/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Back-end</span>
					</a>
				
					<a itemprop="url" href="/cultura/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Cultura</span>
					</a>
				
					<a itemprop="url" href="/data-science/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Data Science</span>
					</a>
				
					<a itemprop="url" href="/design/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Design</span>
					</a>
				
					<a itemprop="url" href="/devops/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Devops</span>
					</a>
				
					<a itemprop="url" href="/eventos/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Eventos</span>
					</a>
				
					<a itemprop="url" href="/front-end/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Front-end</span>
					</a>
				
					<a itemprop="url" href="/mobile/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Mobile</span>
					</a>
				
					<a itemprop="url" href="/vagas/" itemscope itemtype="http://schema.org/SiteNavigationElement">
						<span itemprop="name">Vagas</span>
					</a>
				
			</nav>
		</div>
		<div class="navigation">
			<input id="more-switch" type="checkbox" class="more-switch">
			<label for="more-switch" class="selectable">
				<h2 class="nav-title">Veja também</h2>
			</label>
			<nav class="nav-list nav-more" aria-label="Navegue pelos links relacionados ao Elo7">
				<a itemscope itemtype="http://schema.org/SiteNavigationElement" itemprop="url" href="http://carreira.elo7.com.br/engenharia/" target="_blank">
					<span itemprop="name">A engenharia</span>
				</a>
				<a itemscope itemtype="http://schema.org/SiteNavigationElement" itemprop="url" href="http://carreira.elo7.com.br/" target="_blank">
					<span itemprop="name">Carreiras</span>
				</a>
				<a itemscope itemtype="http://schema.org/SiteNavigationElement" itemprop="url" href="http://eventos.elo7.com.br/" target="_blank">
					<span itemprop="name">Nossos eventos</span>
				</a>
				<a itemscope itemtype="http://schema.org/SiteNavigationElement" itemprop="url" href="http://elo7.com.br/" target="_blank">
					<span itemprop="name">Elo7</span>
				</a>
			</nav>
		</div>
		<div class='social'>
			<a title="Github do Elo7" rel="external" itemprop="url" href="https://github.com/elo7" target="_blank" class="github">Github do Elo7</a>
			<a title="Twitter do Elo7" rel="external" itemprop="url" href="https://twitter.com/elo7tech" target="_blank" class="twitter">Twitter do Elo7</a>
			<a title='RSS do Elo7' rel="external" itemprop="url" href="https://engenharia.elo7.com.br/rss.xml" target="_blank" class="rss">RSS do Elo7</a>
			<a title='Newsletter do Elo7' rel="external" itemprop="url" href="http://eepurl.com/cVUwvH" target="_blank" class="email">Newsletter do Elo7</a>
		</div>
	</header>
	<main aria-label="Main content" itemscope itemtype="http://schema.org/Blog">
		<article itemprop='blogPost' itemscope itemtype='http://schema.org/BlogPosting' class='post-content'>
	<h1 itemprop='name' class='title'>Terraformando tudo - parte 2</h1>
	<div class='post-meta'>
		<p class='date'>
			Publicado em: <time datetime='31/07/2017' itemprop='datePublished'>31/07/2017</time>
			<meta itemprop='dateModified' content='31/07/2017'>
		</p>

		<article>
			
				<a data-author='lucasvasconcelos' itemprop='author' itemscope itemtype='http://schema.org/Person' rel='author' href='/lucasvasconcelos/' class='author'>
					<meta itemprop='url' content='/lucasvasconcelos'>
					<img class='hide avatar' width='50px' height='50px' itemprop='image'>
					<p itemprop='name' class='publisher' data-author='lucasvasconcelos'>@lucasvasconcelos</p>
				</a>
			

			<meta itemprop='worksFor' content='Elo7 Serviços de Informática SA'>
		</article>
	</div>
	<div itemprop='articleBody'>
		<p>Veja os outros <em>posts</em> da série:</p>
<ul>
<li><a href="/terraformando-tudo-1/">Terraformando tudo - parte 1</a></li>
<li><a href="/terraformando-tudo-3/">Terraformando tudo - parte 3</a></li>
</ul>
<p>Olá!</p>
<p>Estamos aqui novamente para dar continuidade na série de <em>posts</em> <em>Terraformando Tudo</em>. Nesse segundo <em>post</em> da série (se não leu o primeiro, leia <a href="/terraformando-tudo-1/">aqui</a>), vamos falar mais um pouco sobre os códigos do <a href="https://terraform.io">Terraform</a>, ou <em>Terraform configuration</em> (como o próprio projeto chama uma porção de código executável do Terraform). Também vamos mostrar como o Terraform controla o estado de seus <em>resources</em> e como mitigar as chances de desastres em um cenário onde podem haver diversas pessoas trabalhando no mesmo repositório de <em>configurations</em></p>
<h2>Terraform configurations</h2>
<p>Seguindo a nomenclatura supracitada, a partir deste ponto, vamos chamar um código do Terraform de <em>configuration</em> (apesar de aqui no Elo7 chamarmos de 'módulo', pra facilitar :P).</p>
<p>Conforme foi citado no <a href="/terraformando-tudo-1/">primeiro post</a>, o Terraform utiliza uma linguagem proprietária chamada HCL (<em>Hashicorp Configuration Language</em>). A seguir, temos um exemplo de <em>configuration</em> mínimo que pode ser executado com o Terraform. Alguns detalhes estão em formato de comentário no código:</p>
<p><code>main.tf</code></p>
<pre class="highlight"><code class="hljs python"><span class="hljs-comment"># Define o provider que será utilizado e os parâmetros necessários</span>
<span class="hljs-comment"># No caso, usaremos a AWS na region us-east-1 e as credenciais, como não foram</span>
<span class="hljs-comment"># explicitadas, irão ser obtidas de variáveis de ambiente ou do arquivo credentials do awscli</span>
<span class="hljs-comment"># (como default na maioria das bibliotecas da AWS)</span>
provider <span class="hljs-string">"aws"</span> {
  region = <span class="hljs-string">"us-east-1"</span>
}

<span class="hljs-comment"># Aqui estamos utilizando a funcionalidade de data-sources do Terraform, que traz</span>
<span class="hljs-comment"># informações de recursos já existentes. Nesse caso, estamos obtendo informações</span>
<span class="hljs-comment"># da imagem (AMI) mais recente do CoreOS stable da AWS</span>
data <span class="hljs-string">"aws_ami"</span> <span class="hljs-string">"coreos-stable-latest"</span> {
  most_recent = true

  filter {
    name = <span class="hljs-string">"name"</span>
    values = [<span class="hljs-string">"CoreOS-stable*"</span>]
  }

  filter {
    name = <span class="hljs-string">"virtualization-type"</span>
    values = [<span class="hljs-string">"hvm"</span>]
  }
  <span class="hljs-comment"># ID do owner da AMI no AWS AMI Marketplace</span>
  <span class="hljs-comment"># (colocado hardcoded aqui para facilitar este exemplo)</span>
  owners = [<span class="hljs-string">"595879546273"</span>]
}

<span class="hljs-comment"># Criando um security-group para a instância</span>
resource <span class="hljs-string">"aws_security_group"</span> <span class="hljs-string">"elo7-sg-example"</span> {
  name = <span class="hljs-string">"elo7-example"</span>
  description = <span class="hljs-string">"SG de exemplo para o post no Blog"</span>
  vpc_id = <span class="hljs-string">"vpc-123456"</span>

  <span class="hljs-comment"># A regra a seguir libera saída para qualquer destino em qualquer protocolo</span>
  egress {
    from_port = <span class="hljs-number">0</span>
    to_port = <span class="hljs-number">0</span>
    protocol = <span class="hljs-string">"-1"</span>
    cidr_blocks = [<span class="hljs-string">"0.0.0.0/0"</span>]
  }

  ingress {
      from_port       = <span class="hljs-string">"22"</span>
      to_port         = <span class="hljs-string">"22"</span>
      protocol        = <span class="hljs-string">"tcp"</span>
      cidr_blocks = [ <span class="hljs-string">"192.168.10.0/21"</span> ]
  }

}


<span class="hljs-comment"># Aqui, estamos definindo uma instância no EC2</span>
resource <span class="hljs-string">"aws_instance"</span> <span class="hljs-string">"elo7-ec2-example"</span> {

  <span class="hljs-comment"># Estamos referenciando o ID da AMI que foi setado no bloco anterior</span>
  ami = <span class="hljs-string">"${data.aws_ami.coreos-stable-latest.id}"</span>
  instance_type = <span class="hljs-string">"t2.small"</span>
  key_name = <span class="hljs-string">"example-key"</span>
  subnet_id = <span class="hljs-string">"subnet-123456"</span>

  <span class="hljs-comment"># Estamos referenciando o ID do security-group criado nesse mesmo arquivo</span>
  <span class="hljs-comment"># O Terraform cuidará de organizar as interdependências</span>
  vpc_security_group_ids = [ <span class="hljs-string">"${aws_security_group.elo7-sg-example.id}"</span> ]

  root_block_device {
    volume_type = <span class="hljs-string">"gp2"</span>
    volume_size = <span class="hljs-string">"15"</span>
    delete_on_termination = true
  }

  tags {
    <span class="hljs-string">"Name"</span> = <span class="hljs-string">"elo7-ec2-example"</span>
  }
}
</code></pre>
<p>Com a <em>configuration</em> acima, conseguimos criar um <em>Security Group</em> e uma instância na região <em>us-east-1</em> da AWS. Podemos ver que o <em>pattern</em> para criação de recursos com o Terraform é sempre este: <code>resource &quot;tipo_do_resource&quot; &quot;nome_do_resource&quot;</code>.</p>
<p>Um outro detalhe é que, para ajudar na organização, poderíamos definir os <em>resources</em> em arquivos separados dentro do mesmo diretório, por exemplo: <code>main.tf</code>, <code>security-groups.tf</code> e <code>ec2.tf</code>. Isso não altera a maneira com que o Terraform irá executar seu código.</p>
<p>Para aplicar o que está descrito no código são necessários 2 comandos:</p>
<ul>
<li><code>terraform plan</code>: Mostra um plano de execução, ou seja, diz o que será adicionado, o que será modificado e o que será removido da sua infra baseado no <em>configuration</em> encontrado no diretório onde esse comando é executado. Esse comando é opcional, mas de extrema importância para sabermos se a mudança é realmente o que estamos esperando.</li>
<li><code>terraform apply</code>: Aplica as mudanças de fato. Se não houve nenhuma modificação desde o momento do <em>plan</em>, as mudanças que foram mostradas por ele serão aplicadas neste momento.</li>
</ul>
<h2>Estado de um <em>resource</em></h2>
<p>O Terraform controla o estado dos resources contidos em um <em>configuration</em> em um arquivo JSON. Esse arquivo deve ser manipulado <strong>apenas</strong> pelo próprio Terraform. Ele utiliza esse arquivo para fazer comparações entre o estado existente (em disco ou armazenado remotamente), o estado que o código espera e o estado existente no <em>provider</em> (AWS, no nosso caso). Por padrão, esse arquivo é criado junto com os arquivos <code>.tf</code> e possui o nome <code>terraform.tfstate</code></p>
<p>O estado dos resources criados no exemplo anterior fica desse jeito (várias linhas foram omitidas):</p>
<pre class="highlight"><code class="hljs javascript">{
    <span class="hljs-string">"version"</span>: <span class="hljs-number">3</span>,
    <span class="hljs-string">"serial"</span>: <span class="hljs-number">4</span>,
    <span class="hljs-string">"lineage"</span>: <span class="hljs-string">"95a8a54a-f153-435e-b5fa-df66fd3c2c57"</span>,
    <span class="hljs-string">"modules"</span>: [
        {
            <span class="hljs-string">"path"</span>: [
                <span class="hljs-string">"root"</span>
            ],
            <span class="hljs-string">"outputs"</span>: {},
            <span class="hljs-string">"resources"</span>: {
                <span class="hljs-string">"aws_instance.elo7-ec2-example"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"aws_instance"</span>,
                    <span class="hljs-string">"depends_on"</span>: [
                        <span class="hljs-string">"aws_security_group.elo7-sg-example"</span>,
                        <span class="hljs-string">"data.aws_ami.coreos-stable-latest"</span>
                    ],
                    <span class="hljs-string">"primary"</span>: {
                        <span class="hljs-string">"id"</span>: <span class="hljs-string">"i-0c2d521d1861a806d"</span>,
                        <span class="hljs-string">"attributes"</span>: {
                            <span class="hljs-string">"ami"</span>: <span class="hljs-string">"ami-7ee7e169"</span>,
                            <span class="hljs-string">"availability_zone"</span>: <span class="hljs-string">"us-east-1b"</span>,
                            <span class="hljs-string">"id"</span>: <span class="hljs-string">"i-123456"</span>,
                            <span class="hljs-string">"instance_state"</span>: <span class="hljs-string">"running"</span>,
                            <span class="hljs-string">"instance_type"</span>: <span class="hljs-string">"t2.small"</span>,
                            <span class="hljs-string">"key_name"</span>: <span class="hljs-string">"example_key"</span>,
                            <span class="hljs-string">"private_ip"</span>: <span class="hljs-string">"192.168.10.111"</span>,
                            <span class="hljs-string">"security_groups.#"</span>: <span class="hljs-string">"0"</span>,
                            <span class="hljs-string">"subnet_id"</span>: <span class="hljs-string">"subnet-123456"</span>,
                            <span class="hljs-string">"tags.%"</span>: <span class="hljs-string">"1"</span>,
                            <span class="hljs-string">"tags.Name"</span>: <span class="hljs-string">"elo7-ec2-example"</span>,
                            <span class="hljs-string">"user_data"</span>: <span class="hljs-string">"1c338728002999224f8c8283650db76768b34112"</span>,
                            <span class="hljs-string">"vpc_security_group_ids.#"</span>: <span class="hljs-string">"1"</span>,
                            <span class="hljs-string">"vpc_security_group_ids.3439610007"</span>: <span class="hljs-string">"sg-123456"</span>,
                        }
                    }
                },
                <span class="hljs-string">"aws_security_group.elo7-sg-example"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"aws_security_group"</span>,
                    <span class="hljs-string">"depends_on"</span>: [],
                    <span class="hljs-string">"primary"</span>: {
                        <span class="hljs-string">"id"</span>: <span class="hljs-string">"sg-123456"</span>,
                        <span class="hljs-string">"attributes"</span>: {
                            <span class="hljs-string">"description"</span>: <span class="hljs-string">"SG de exemplo para o post no Blog"</span>,
                            <span class="hljs-string">"egress.#"</span>: <span class="hljs-string">"1"</span>,
                            <span class="hljs-string">"egress.482069346.cidr_blocks.#"</span>: <span class="hljs-string">"1"</span>,
                            <span class="hljs-string">"egress.482069346.cidr_blocks.0"</span>: <span class="hljs-string">"0.0.0.0/0"</span>,
                            <span class="hljs-string">"egress.482069346.from_port"</span>: <span class="hljs-string">"0"</span>,
                            <span class="hljs-string">"egress.482069346.prefix_list_ids.#"</span>: <span class="hljs-string">"0"</span>,
                            <span class="hljs-string">"egress.482069346.protocol"</span>: <span class="hljs-string">"-1"</span>,
                            <span class="hljs-string">"egress.482069346.security_groups.#"</span>: <span class="hljs-string">"0"</span>,
                            <span class="hljs-string">"egress.482069346.self"</span>: <span class="hljs-string">"false"</span>,
                            <span class="hljs-string">"egress.482069346.to_port"</span>: <span class="hljs-string">"0"</span>,
                            <span class="hljs-string">"id"</span>: <span class="hljs-string">"sg-123456"</span>,
                            <span class="hljs-string">"ingress.#"</span>: <span class="hljs-string">"1"</span>,
                            <span class="hljs-string">"ingress.2063172013.cidr_blocks.#"</span>: <span class="hljs-string">"1"</span>,
                            <span class="hljs-string">"ingress.2063172013.cidr_blocks.0"</span>: <span class="hljs-string">"172.16.0.0/16"</span>,
                            <span class="hljs-string">"ingress.2063172013.from_port"</span>: <span class="hljs-string">"22"</span>,
                            <span class="hljs-string">"ingress.2063172013.protocol"</span>: <span class="hljs-string">"tcp"</span>,
                            <span class="hljs-string">"ingress.2063172013.security_groups.#"</span>: <span class="hljs-string">"0"</span>,
                            <span class="hljs-string">"ingress.2063172013.self"</span>: <span class="hljs-string">"false"</span>,
                            <span class="hljs-string">"ingress.2063172013.to_port"</span>: <span class="hljs-string">"22"</span>,
                            <span class="hljs-string">"name"</span>: <span class="hljs-string">"elo7-sg-example"</span>,
                        }
                    }
                },
                <span class="hljs-string">"data.aws_ami.coreos-stable-latest"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"aws_ami"</span>,
                    <span class="hljs-string">"depends_on"</span>: [],
                    <span class="hljs-string">"primary"</span>: {
                        <span class="hljs-string">"id"</span>: <span class="hljs-string">"ami-7ee7e169"</span>,
                        <span class="hljs-string">"attributes"</span>: {
                            <span class="hljs-string">"architecture"</span>: <span class="hljs-string">"x86_64"</span>,
                            <span class="hljs-string">"description"</span>: <span class="hljs-string">"CoreOS stable 1185.5.0 (HVM)"</span>,
                            <span class="hljs-string">"hypervisor"</span>: <span class="hljs-string">"xen"</span>,
                            <span class="hljs-string">"id"</span>: <span class="hljs-string">"ami-7ee7e169"</span>,
                            <span class="hljs-string">"image_id"</span>: <span class="hljs-string">"ami-7ee7e169"</span>,
                            <span class="hljs-string">"image_location"</span>: <span class="hljs-string">"595879546273/CoreOS-stable-1185.5.0-hvm"</span>,
                            <span class="hljs-string">"image_type"</span>: <span class="hljs-string">"machine"</span>,
                            <span class="hljs-string">"most_recent"</span>: <span class="hljs-string">"true"</span>,
                            <span class="hljs-string">"name"</span>: <span class="hljs-string">"CoreOS-stable-1185.5.0-hvm"</span>,
                            <span class="hljs-string">"state"</span>: <span class="hljs-string">"available"</span>,
                            <span class="hljs-string">"virtualization_type"</span>: <span class="hljs-string">"hvm"</span>
                        }
                    }
                }
            },
            <span class="hljs-string">"depends_on"</span>: []
        }
    ]
}
</code></pre>
<p>É com esse estado que o Terraform decide o que deve ser feito, baseando-se no código e também no que já existe no <em>provider</em> (no nosso caso, na AWS). Também é possível gerar o estado de uma infra já existente no seu <em>provider</em>... (mas isso ficará para um próximo <em>post</em> dessa série ;)).</p>
<p>Com esse mecanismo, o controle dos <em>resources</em> funciona muito bem, porém, detectamos um problema. O Terraform gera um arquivo <code>terraform.tfstate</code> no diretório do <em>configuration</em> ao rodar o <code>terraform apply</code>. Isso é gerado em <em>runtime</em>, e se pensarmos de maneira distribuída, com vários desenvolvedores alterando os <em>configurations</em>, isso pode ser bem ruim. Afinal, se algum desenvolvedor não possuir o estado atual dos <em>resources</em> de um determinado <em>configuration</em> ao executar um <em>apply</em>, a infra será recriada pelo Terraform (até onde for possível, pois alguns <em>resources</em> não permitem duplicidade). Isso pode causar catástrofes em alguns casos, como um registro de DNS sendo sobrescrito e indisponibilizando alguma aplicação. E essa é uma situação que queremos bem longe da gente.</p>
<p>A próxima seção discutirá sobre como mitigar esse problema.</p>
<h2>Estado centralizado</h2>
<p>Se estamos falando de um estado, logo esperamos que ele seja consistente. Para tal, o estado deve ser armazenado em um local centralizado. E foi isso que fizemos para nos ajudar com o problema que foi citado anteriormente.</p>
<p>A solução óbvia, baseando-se no que já foi visto - estamos lidando com código (IaC) e o estado do Terraform nada mais é que um JSON (ou seja, mais texto) - seria versionar o estado junto com o código da infraestrutura, e assim mantê-lo centralizado no repositório do nosso controle de versão.</p>
<p>Inicialmente isso pode parecer uma boa ideia, mas ela oferece um grande problema pra nós: trabalhamos com <em>branches</em>, e caso dois desenvolvedores abram uma <em>branch</em>, cada um de um mesmo <em>configuration</em>, ao fazer um teste ou aplicar o que está na <em>branch</em>, o estado entre elas e a <em>master</em> vai ficar inconsistente, ou seja, voltamos ao problema do estado distribuído. Mesmo em um caso onde exista apenas uma <em>branch</em>, ao modificar seu estado e fazer um <em>merge</em> na <em>master</em>, estaremos nós mesmos modificando o estado do Terraform e isso é errado (lembram-se que no começo do post foi dito que o estado só deveria ser manipulado pelo próprio Terraform, né?).</p>
<p>A melhor solução seria termos o estado do <em>configuration</em> guardado em um ponto central, onde, independente da <em>branch</em> na qual os desenvolvedores estão fazendo alterações, um único estado será modificado. E o Terraform, como boa ferramenta que é, pode nos ajudar com isso.</p>
<p>O Terraform possui a funcionalidade chamada <a href="https://www.terraform.io/docs/state/remote/index.html"><em>Remote State</em></a> que, como o nome já diz, permite com que o estado seja guardado em um local remoto centralizado. O Terraform dá suporte a algumas ferramentas para armazenar o estado, como o <a href="https://www.consul.io">Consul</a> e o <a href="https://aws.amazon.com/s3/pricing/">S3</a> da AWS.</p>
<p>Para nós, centralizar os estados dos <em>configurations</em> no S3 fez mais sentido. Conseguimos fazer isso adicionando o seguinte bloco em nossos <em>configurations</em>:</p>
<pre class="highlight"><code class="hljs python">terraform {
  backend <span class="hljs-string">"s3"</span> {
    bucket     = <span class="hljs-string">"${S3_BUCKET}"</span>
    key        = <span class="hljs-string">"${S3_OBJECT}"</span>
    region     = <span class="hljs-string">"${S3_BUCKET_REGION}"</span>
    <span class="hljs-comment"># O Terraform também oferece a opção de utilizar uma tabela no DynamoDB (https://aws.amazon.com/pt/dynamodb/)</span>
    <span class="hljs-comment"># como lock para o estado em questão, evitando condições de corrida no arquiv.</span>
    lock_table = <span class="hljs-string">"terraform_state_locking"</span>
  }
}
</code></pre>
<p>Com isso, automaticamente, a cada <code>plan</code> e/ou <code>apply</code> do Terraform nas estações de trabalho dos desenvolvedores, um único arquivo de estado é modificado, e conseguimos manter nosso estado em um local centralizado para cada <em>configuration</em>.</p>
<p>Uma dica para quem for utilizar o S3 como local de armazenamento para os estados é que o <em>bucket</em> tenha a opção de versionamento ativada, pois isso pode ajudar a corrigir possíveis inconsistências nos estados.</p>
<p>Uma outra grande vantagem que o uso de <em>Remote States</em> oferece é a possibilidade de referenciar os <code>outputs</code> de um <em>configuration</em> em outro sem correr riscos de alterações indevidas. Isso pode ser feito com o <em>resource terraform_remote_state</em>.</p>
<p>Um exemplo de como obtemos os IDs das zonas do Route53 para podermos criar novos registros em um <em>configuration</em>:</p>
<pre class="highlight"><code class="hljs python">data <span class="hljs-string">"terraform_remote_state"</span> <span class="hljs-string">"route53"</span> {
    backend = <span class="hljs-string">"s3"</span>
    config {
        bucket = <span class="hljs-string">"BUCKET_NAME"</span>
        key = <span class="hljs-string">"BUCKET_NAME/route53/route53.tfstate"</span>
        region = <span class="hljs-string">"BUCKET_REGION"</span>
    }
}
</code></pre>
<p>Assim, conseguimos referenciar de maneira <em>read-only</em> o ID que precisamos para criação de um novo registro (lembrando que só é possível referenciar o que foi explicitamente exportado no módulo de origem):</p>
<pre class="highlight"><code class="hljs python">resource <span class="hljs-string">"aws_route53_record"</span> <span class="hljs-string">"dns-public-web-app"</span> {
  zone_id = <span class="hljs-string">"${data.terraform_remote_state.route53.zone01.id}"</span>
  name = <span class="hljs-string">"public-web-app.elo7.com.br"</span>
  type = <span class="hljs-string">"A"</span>
  ttl = <span class="hljs-string">"300"</span>
  records = [<span class="hljs-string">"${aws_instance.public-web-app.private_ip}"</span>]
}
</code></pre>
<h2>Limitações</h2>
<p>Utilizar o <em>Remote State</em> com o Terraform alivia bastante os problemas de desenvolvimento paralelo dos <em>configurations</em> que foram citados até aqui. Porém, ainda devemos tomar alguns cuidados ao lidar com esse modelo.</p>
<p>Temos o seguinte cenário de exemplo:</p>
<ul>
<li><em>configuration</em>: <code>public-web-app</code>, que já possui uma série de <em>resources</em> criados, como instâncias, banco de dados, registros DNS, etc.</li>
</ul>
<p>Desenvolvedores criam as seguintes <em>branches</em>:</p>
<ul>
<li><em>Dev 1</em> cria branch: <code>adiciona-ALB</code></li>
<li><em>Dev 2</em> cria branch: <code>adiciona-discos-para-logs</code></li>
</ul>
<p>Supondo que o <em>Dev 1</em> trabalhe em sua <em>branch</em> primeiro, e adiciona um ALB (Application Load Balancer) no <em>configuration</em> do <code>public-web-app</code>. Nesse momento, o estado desse <em>configuration</em> vai possuir informações sobre o ALB criado.
O <em>Dev 2</em>, por sua vez, vai fazer suas alterações. Porém, no momento que ele criou sua <em>branch</em>, o código do ALB criado pelo <em>Dev 1</em> ainda não existia, mas tais informações existem no estado. Então, o <em>Dev 2</em> vai fazer suas alterações, e vai executar o <code>terraform plan</code>.
O plano mostrado pelo Terraform para o <em>Dev 2</em> dirá que os discos que ele adicionou serão provisionados e <em>attachados</em> nas instâncias pois, obviamente, tais <em>resources</em> não existiam no estado. Entretanto, algo estranho também aparecerá para o <em>Dev 2</em>: o Terraform o informará que irá remover um ALB, pois ele encontrou tal <em>resource</em> no estado e não no código.</p>
<p>E agora? Como lidamos com as limitações?</p>
<p>O Terraform não é capaz de controlar mudanças distribuídas (a Hashicorp possui uma versão Enterprise do Terraform que oferece esse controle centralizado). Então, a opção mais barata e direta é termos processos de uso da ferramenta:</p>
<ul>
<li>Quebramos os nossos <em>configurations</em> por aplicações (às vezes uma aplicação possui mais de um <em>configuration</em>, caso ela tenha muitas dependências): isso diminui bastante as chances de existirem dois desenvolvedores alterando o mesmo <em>configuration</em> simultaneamente;</li>
<li>Caso a <em>branch</em> seja antiga, um <em>rebase</em> da <em>master</em> resolve o problema, pois novas alterações que já foram <em>mergeadas</em> são aplicadas na <em>branch</em> atual;</li>
<li>Em último caso, utilizamos o argumento <code>-target=</code> do Terraform, que permite passar exatamente quais resources queremos que sejam modificados. No caso do exemplo anterior, o <em>Dev 2</em> poderia apontar os seus discos no <code>-target=</code> e rodar um <code>terraform apply</code>. Assim, seus discos seriam criados e o ALB continuaria intacto.</li>
<li>Vale salientar, também, que o que está sendo desenvolvido em uma <em>branch</em>, mesmo que aplicado, não é considerado &quot;em produção&quot;. O ambiente de produção é considerado aquele que está na <em>master</em> do repositório, ou seja, um <code>terraform apply</code> na <em>master</em> não deve nunca causar nenhum dano às nossas aplicações.</li>
</ul>
<h2>Conclusões</h2>
<p>Nesse post mostramos como o Terraform se organiza internamente com a infraestrutura que ele controla, e como trabalhamos de maneira distribuída com os <em>configurations</em>. Também citamos alguns procedimentos que usamos para diminuir os problemas que as limitações do modelo trazem.</p>
<p>Por enquanto o método de trabalho descrito aqui está nos atendendo muito bem. Mas temos em mente que podemos chegar a uma escala em que esse método não será suficiente. Quando isso ocorrer, vamos pensar em outras abordagens, como desenvolver uma ferramenta interna para controle de modificações em paralelo ou até mesmo contratar o serviço oferecido pela Hashicorp.</p>
<p>Finalizamos, então, mais um post da série Terraformando Tudo. Mas ela ainda não terminou! Voltaremos aqui em um próximo post, mostrando o que fazer com a infraestrutura já existente! Podemos <em>&quot;terraformá-la&quot;</em>? Veremos!</p>


		<ul class='tag-list'>
		
			<li>
				<a href='/tags/devops/'>devops</a>
			</li>
		
			<li>
				<a href='/tags/terraform/'>terraform</a>
			</li>
		
			<li>
				<a href='/tags/iac/'>iac</a>
			</li>
		
			<li>
				<a href='/tags/infrastructure-as-code/'>infrastructure as code</a>
			</li>
		
			<li>
				<a href='/tags/infra/'>infra</a>
			</li>
		
		</ul>
		<section class='share'>
			<a href='#share' class='share-post hide' title='Clique aqui para compartilhar esse post'>Compartilhe</a>
			<div class='social-share'>
				<a href='https://www.facebook.com/dialog/share?app_id=644444999041914&href=https://engenharia.elo7.com.br/terraformando-tudo-2/&display=popup' rel='noopener' target='_blank' class='link-share facebook' title='Clique para compartilhar no Facebook'>
					Compartilhar no facebook
				</a>
				<a href='https://twitter.com/intent/tweet?text=Terraformando tudo - parte 2&url=https://engenharia.elo7.com.br/terraformando-tudo-2/&hashtags=elo7tech' rel='noopener' target='_blank' class='link-share twitter' title='Clique para compartilhar no Twitter'>
					Compartilhar no twitter
				</a>
				<a href='https://engenharia.elo7.com.br/terraformando-tudo-2/?utm_source=share&utm_medium=copy' class='link-share hide copy' title='Clique para copiar a url'>
					Copiar URL
				</a>
				<span class='copy-success'>Link copiado</span>
				<input type='url' value='https://engenharia.elo7.com.br/terraformando-tudo-2/?utm_source=share&utm_medium=copy' class='link-input'>
			</div>
		</section>
	</div>
	<span itemprop="image" itemscope itemtype="http://schema.org/ImageObject"> <!--Change for a post image-->
		<link href="/images/ico/elo7.png" itemprop="url"/>
		<meta itemprop='width' content='100px'/>
		<meta itemprop='height' content='100px'/>
	</span>

	<meta itemprop='headline' content='Segundo post da série &#x27;Terraformando Tudo&#x27;, que conta a nossa trajetória em busca da codificação da nossa infraestrutura. Neste post contamos o que fizemos para mitigar possíveis desastres e como controlamos N desenvolvedores alterando N Terraform configurations. Vamos lá?'/>
	<span itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
		<meta itemprop='name' content='Elo7 Tech'/>
		<meta itemprop="url" content='https://engenharia.elo7.com.br'/>
		<span itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
			<link href="https://images.elo7.com.br/assets/v3/desktop/png/logo-elo7.png" itemprop="url"/>
			<meta itemprop='width' content='100px'/>
			<meta itemprop='height' content='100px'/>
		</span>
	</span>
	<meta itemprop='mainEntityOfPage' content='Elo7 Serviços de Informática SA'/>

	<div id='disqus_thread'></div>

	<script>
		var disqus_shortname = 'engenhariaelo7';
		var disqus_identifier = '31/07/2017:/terraformando-tudo-2/';
		var disqus_url = 'https://engenharia.elo7.com.br/terraformando-tudo-2/';

		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Habilite o JavaScript para ver os comentários</noscript>
</article>
<script async src="/js/post.js"></script>

		
	</main>
	<footer itemscope itemtype="http://schema.org/Organization">
		<a rel="home" itemprop="url" href="https://engenharia.elo7.com.br/" >
			engenharia.elo7.com.br © 2017
		</a>
		<meta itemprop="name" content="Elo7 Serviços de Informática SA"/>
		<section class='footer-social'>
			<a title='Github do Elo7' rel='external' itemprop='url' href='https://github.com/elo7' target='_blank' class='github'>Github do Elo7</a>
			<a title='Twitter do Elo7' rel='external' itemprop='url' href='https://twitter.com/elo7tech' target='_blank' class='twitter'>Twitter do Elo7</a>
			<a title='RSS do Elo7' rel='external' itemprop='url' href='https://engenharia.elo7.com.br/rss.xml' target='_blank' class='rss'>RSS do Elo7</a>
			<a title='Newsletter do Elo7' rel='external' itemprop='url' href='http://eepurl.com/cVUwvH' target='_blank' class='email'>Newsletter do Elo7</a>
		</section>
	</footer>
	<script async src="https://www.google-analytics.com/analytics.js"></script>
	<script async src="/js/analytics.js"></script>
	<script async src="/js/github.js"></script>
	<script async src="/js/vendor/events-amd.js"></script>
	<script async src="/js/vendor/ajax.js"></script>
	<script async src="/js/vendor/doc.js"></script>
	<script async type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
